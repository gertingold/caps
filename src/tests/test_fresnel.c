/* automatically generated by src/tests/test_fresnel.py */

#include "libcaps.h"
#include "misc.h"
#include "constants.h"
#include "unittest.h"

#include "test_fresnel.h"

int test_caps_fresnel()
{
    unittest_t test;
    caps_t *caps;
    double rTE, rTM;
    double userdata[2];

    unittest_init(&test, "caps_fresnel", "Fresnel coefficients", 2e-15);

    caps = caps_init(1.000000e-04,1.000000e-06);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 1e-05/CAPS_hbar_eV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558167);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301509764022);
    AssertAlmostEqual(&test, rTM, 0.9999999720393561);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.999999999519472);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014521366);
    AssertAlmostEqual(&test, rTM, 0.9999999996081784);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091671);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996091771);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206545454e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999996091771);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860412);
    AssertAlmostEqual(&test, rTM, 0.9990339397516345);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689123);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936135049958998);
    AssertAlmostEqual(&test, rTM, 0.9999989265270348);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026625102e-06);
    AssertAlmostEqual(&test, rTM, 0.9999995329113147);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318396898e-12);
    AssertAlmostEqual(&test, rTM, 0.9999995329123147);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815927108);
    AssertAlmostEqual(&test, rTM, 0.9607322815965588);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172676);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727582);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.670354331861994);
    AssertAlmostEqual(&test, rTM, 0.9959435677173295);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.9991038390080457);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539184183149e-06);
    AssertAlmostEqual(&test, rTM, 0.9991981447270014);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616886374274e-12);
    AssertAlmostEqual(&test, rTM, 0.9991981547149046);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775428056058795);
    AssertAlmostEqual(&test, rTM, 0.6775428056061399);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.6775429358431652);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6762450372613529);
    AssertAlmostEqual(&test, rTM, 0.6788363685652938);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5785904806533553);
    AssertAlmostEqual(&test, rTM, 0.7568389502521059);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05733101837211199);
    AssertAlmostEqual(&test, rTM, 0.920412792491733);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516081416440753e-06);
    AssertAlmostEqual(&test, rTM, 0.928735181632379);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172851979716e-12);
    AssertAlmostEqual(&test, rTM, 0.928736077267725);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950553);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247874);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772412);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05756624267702898);
    AssertAlmostEqual(&test, rTM, 0.05859111223704998);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813653);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150154e-06);
    AssertAlmostEqual(&test, rTM, 0.1157604305106686);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174683688531e-12);
    AssertAlmostEqual(&test, rTM, 0.1157668882218177);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970508388e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970508387e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405970501839e-06);
    AssertAlmostEqual(&test, rTM, 6.549405970514937e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549405905015187e-06);
    AssertAlmostEqual(&test, rTM, 6.549406036001588e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194756e-06);
    AssertAlmostEqual(&test, rTM, 6.54941251982202e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54875110397602e-06);
    AssertAlmostEqual(&test, rTM, 6.550060837040755e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274724432648594e-06);
    AssertAlmostEqual(&test, rTM, 9.824087508227714e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549485211217329e-12);
    AssertAlmostEqual(&test, rTM, 1.309880539096969e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150859e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150859e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150858e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250150793e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250150923e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525250144309e-12);
    AssertAlmostEqual(&test, rTM, 6.549525250157407e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549525249495906e-12);
    AssertAlmostEqual(&test, rTM, 6.54952525080581e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549518700632158e-12);
    AssertAlmostEqual(&test, rTM, 6.549531799669558e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762625096877e-12);
    AssertAlmostEqual(&test, rTM, 9.824287875204838e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 0.001/CAPS_hbar_eV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047315818192);
    AssertAlmostEqual(&test, rTM, 0.9998023462554779);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149442);
    AssertAlmostEqual(&test, rTM, 0.9999997177303033);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205182806);
    AssertAlmostEqual(&test, rTM, 0.9999999608254035);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770173473e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609242759);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150764e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999609252659);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625657e-17);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902193169381);
    AssertAlmostEqual(&test, rTM, 0.9911902280877321);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.98756390651418);
    AssertAlmostEqual(&test, rTM, 0.99376243919542);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838007);
    AssertAlmostEqual(&test, rTM, 0.9999032480337134);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.9999598630564425);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780782371855);
    AssertAlmostEqual(&test, rTM, 0.999960840543927);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858806546e-08);
    AssertAlmostEqual(&test, rTM, 0.9999608505410629);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891427829e-14);
    AssertAlmostEqual(&test, rTM, 0.9999608505420629);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310879253);
    AssertAlmostEqual(&test, rTM, 0.9079053108880177);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9079096930284706);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8723352451542481);
    AssertAlmostEqual(&test, rTM, 0.9339146140361048);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3919097588691506);
    AssertAlmostEqual(&test, rTM, 0.9893899239093975);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.9952525883422696);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460015921595e-06);
    AssertAlmostEqual(&test, rTM, 0.995350826714998);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318396887e-12);
    AssertAlmostEqual(&test, rTM, 0.9953508366453478);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.6212976663491003);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264454);
    AssertAlmostEqual(&test, rTM, 0.6212978114714225);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6198519326646842);
    AssertAlmostEqual(&test, rTM, 0.622739182323004);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5132335499853442);
    AssertAlmostEqual(&test, rTM, 0.7099692346882719);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03956560366247852);
    AssertAlmostEqual(&test, rTM, 0.8884765392735431);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149634e-06);
    AssertAlmostEqual(&test, rTM, 0.8965255993486199);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152733869205e-12);
    AssertAlmostEqual(&test, rTM, 0.8965264494859176);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897713);
    AssertAlmostEqual(&test, rTM, 0.05557345736897812);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0555734568717593);
    AssertAlmostEqual(&test, rTM, 0.05557345786619595);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.05557842910341855);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05508066163348158);
    AssertAlmostEqual(&test, rTM, 0.05606622603057572);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02935116395116615);
    AssertAlmostEqual(&test, rTM, 0.08171931191298329);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624601e-06);
    AssertAlmostEqual(&test, rTM, 0.1107985510416759);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616885751274e-12);
    AssertAlmostEqual(&test, rTM, 0.1108047044670981);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025427e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025426e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981018881e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981031972e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088915565395e-06);
    AssertAlmostEqual(&test, rTM, 6.546089046485458e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028694e-06);
    AssertAlmostEqual(&test, rTM, 6.54609552702216e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.545434446150155e-06);
    AssertAlmostEqual(&test, rTM, 6.546743515900697e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27306591618825e-06);
    AssertAlmostEqual(&test, rTM, 9.819112045722349e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168138175011e-12);
    AssertAlmostEqual(&test, rTM, 1.30921714153217e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361412e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361413e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361412e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931361347e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931361477e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521931354863e-12);
    AssertAlmostEqual(&test, rTM, 6.549521931367962e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521930706461e-12);
    AssertAlmostEqual(&test, rTM, 6.549521932016365e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515381846031e-12);
    AssertAlmostEqual(&test, rTM, 6.549528480876794e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760965702154e-12);
    AssertAlmostEqual(&test, rTM, 9.82428289702067e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 0.003/CAPS_hbar_eV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993154745255003);
    AssertAlmostEqual(&test, rTM, 0.9996576786607735);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.619037648123555);
    AssertAlmostEqual(&test, rTM, 0.9999995018141582);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000426170253214032);
    AssertAlmostEqual(&test, rTM, 0.9999998826760321);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891806151e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998827749895);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764561e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998827759795);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998827759895);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626607e-18);
    AssertAlmostEqual(&test, rTM, 0.9999998827759895);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848001671105664);
    AssertAlmostEqual(&test, rTM, 0.9848001821939821);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9785722785821304);
    AssertAlmostEqual(&test, rTM, 0.9892278084628674);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437546566316268);
    AssertAlmostEqual(&test, rTM, 0.9998071126566701);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.004226603668063391);
    AssertAlmostEqual(&test, rTM, 0.9998817178718084);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200692508577e-05);
    AssertAlmostEqual(&test, rTM, 0.9998827034707196);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049115829e-09);
    AssertAlmostEqual(&test, rTM, 0.9998827134675343);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26256408545896e-15);
    AssertAlmostEqual(&test, rTM, 0.9998827134685341);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692065999013);
    AssertAlmostEqual(&test, rTM, 0.853969206613354);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539624803798709);
    AssertAlmostEqual(&test, rTM, 0.853975932547987);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8001009499579576);
    AssertAlmostEqual(&test, rTM, 0.8941745821582564);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2331557994055221);
    AssertAlmostEqual(&test, rTM, 0.9802433533257714);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972396973814765);
    AssertAlmostEqual(&test, rTM, 0.9875704107363228);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004543070045452e-07);
    AssertAlmostEqual(&test, rTM, 0.9876681542434534);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546317362634e-13);
    AssertAlmostEqual(&test, rTM, 0.9876681640592224);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419533074447712);
    AssertAlmostEqual(&test, rTM, 0.5419533074450931);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5419531464544441);
    AssertAlmostEqual(&test, rTM, 0.5419534684353804);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.540350136358117);
    AssertAlmostEqual(&test, rTM, 0.5435525439058442);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4258130659848446);
    AssertAlmostEqual(&test, rTM, 0.6405246587606461);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02434520098821749);
    AssertAlmostEqual(&test, rTM, 0.8304188096334445);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583090903381753e-06);
    AssertAlmostEqual(&test, rTM, 0.8378251546225755);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.58310683123901e-12);
    AssertAlmostEqual(&test, rTM, 0.8378259245078266);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0511204564980125);
    AssertAlmostEqual(&test, rTM, 0.05112045649801342);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045603653251);
    AssertAlmostEqual(&test, rTM, 0.05112045695949342);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05111584211103601);
    AssertAlmostEqual(&test, rTM, 0.05112507088280724);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05066311531895144);
    AssertAlmostEqual(&test, rTM, 0.05157777623724135);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02688270358970822);
    AssertAlmostEqual(&test, rTM, 0.07529813795121811);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677069318356933e-06);
    AssertAlmostEqual(&test, rTM, 0.1019688050887357);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.6777014898834e-12);
    AssertAlmostEqual(&test, rTM, 0.101974423121076);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53939823153429e-06);
    AssertAlmostEqual(&test, rTM, 6.539398231534289e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53939823152775e-06);
    AssertAlmostEqual(&test, rTM, 6.539398231540828e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539398166141164e-06);
    AssertAlmostEqual(&test, rTM, 6.539398296927416e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539391692228124e-06);
    AssertAlmostEqual(&test, rTM, 6.539404770840455e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.53874436564956e-06);
    AssertAlmostEqual(&test, rTM, 6.540052097419019e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.269720497666716e-06);
    AssertAlmostEqual(&test, rTM, 9.80907596526204e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539477220268955e-12);
    AssertAlmostEqual(&test, rTM, 1.307878992303206e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226746531e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226746531e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522674653e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226746466e-12);
    AssertAlmostEqual(&test, rTM, 6.549515226746596e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226739982e-12);
    AssertAlmostEqual(&test, rTM, 6.54951522675308e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549515226091579e-12);
    AssertAlmostEqual(&test, rTM, 6.549515227401482e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549508677237854e-12);
    AssertAlmostEqual(&test, rTM, 6.549521776255207e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274757613394713e-12);
    AssertAlmostEqual(&test, rTM, 9.824272840098347e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 0.035/CAPS_hbar_eV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9976638340553685);
    AssertAlmostEqual(&test, rTM, 0.9988312336213561);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215487336207999);
    AssertAlmostEqual(&test, rTM, 0.9999978539404817);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254224983e-05);
    AssertAlmostEqual(&test, rTM, 0.9999986322890735);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656002884415474e-07);
    AssertAlmostEqual(&test, rTM, 0.9999986323880696);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959225e-09);
    AssertAlmostEqual(&test, rTM, 0.9999986323890596);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999986323890696);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557692015e-19);
    AssertAlmostEqual(&test, rTM, 0.9999986323890696);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.949048941939528);
    AssertAlmostEqual(&test, rTM, 0.9490489915586007);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9287202542954748);
    AssertAlmostEqual(&test, rTM, 0.963689156939934);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410360521874174);
    AssertAlmostEqual(&test, rTM, 0.9985378013953867);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653127504342103);
    AssertAlmostEqual(&test, rTM, 0.9986331813666371);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65577492544717e-06);
    AssertAlmostEqual(&test, rTM, 0.9986341689732928);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65580168885574e-10);
    AssertAlmostEqual(&test, rTM, 0.9986341789517802);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65580169153237e-16);
    AssertAlmostEqual(&test, rTM, 0.9986341789527782);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416800705605);
    AssertAlmostEqual(&test, rTM, 0.5953416801007622);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953265798408696);
    AssertAlmostEqual(&test, rTM, 0.5953567799099105);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4840051873409202);
    AssertAlmostEqual(&test, rTM, 0.6877103920191299);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03361754826397104);
    AssertAlmostEqual(&test, rTM, 0.8712319864611141);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003632706601326185);
    AssertAlmostEqual(&test, rTM, 0.8790192462543475);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710585660193e-08);
    AssertAlmostEqual(&test, rTM, 0.879101792196025);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710886384845e-14);
    AssertAlmostEqual(&test, rTM, 0.8791018004556252);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139514861177887);
    AssertAlmostEqual(&test, rTM, 0.2139514861180658);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139513475818033);
    AssertAlmostEqual(&test, rTM, 0.2139516246540426);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2125754584269058);
    AssertAlmostEqual(&test, rTM, 0.2153266652518543);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1308042368409233);
    AssertAlmostEqual(&test, rTM, 0.2941099688357157);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003405120884454353);
    AssertAlmostEqual(&test, rTM, 0.4063339990152889);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462708001454562e-07);
    AssertAlmostEqual(&test, rTM, 0.4091726931605363);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713862229688e-13);
    AssertAlmostEqual(&test, rTM, 0.409172981457556);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02242247275892319);
    AssertAlmostEqual(&test, rTM, 0.02242247275892361);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224725445335);
    AssertAlmostEqual(&test, rTM, 0.0224224729733133);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224203290649635);
    AssertAlmostEqual(&test, rTM, 0.02242461645267712);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02221011430859486);
    AssertAlmostEqual(&test, rTM, 0.02263482918592128);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01146399723943593);
    AssertAlmostEqual(&test, rTM, 0.03337556286922145);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.34604112766608e-06);
    AssertAlmostEqual(&test, rTM, 0.04482006894827828);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286740490677e-12);
    AssertAlmostEqual(&test, rTM, 0.04482241027400025);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410879593e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410879592e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176410873159e-06);
    AssertAlmostEqual(&test, rTM, 6.434176410886026e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434176346538658e-06);
    AssertAlmostEqual(&test, rTM, 6.434176475220528e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434169976792413e-06);
    AssertAlmostEqual(&test, rTM, 6.434182844966772e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.433533065851852e-06);
    AssertAlmostEqual(&test, rTM, 6.434819755907334e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.217108904786135e-06);
    AssertAlmostEqual(&test, rTM, 9.651243916839869e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434252774595296e-12);
    AssertAlmostEqual(&test, rTM, 1.286834638697368e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954775231e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954775231e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795477523e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954775165e-12);
    AssertAlmostEqual(&test, rTM, 6.549407954775295e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954768681e-12);
    AssertAlmostEqual(&test, rTM, 6.549407954781779e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407954120289e-12);
    AssertAlmostEqual(&test, rTM, 6.54940795543017e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549401405373825e-12);
    AssertAlmostEqual(&test, rTM, 6.549414504176635e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274703977409062e-12);
    AssertAlmostEqual(&test, rTM, 9.824111932141397e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 0.05/CAPS_hbar_eV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083850761646);
    AssertAlmostEqual(&test, rTM, 0.9986032163550014);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744274831007835);
    AssertAlmostEqual(&test, rTM, 0.9999972207023462);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072950870401e-05);
    AssertAlmostEqual(&test, rTM, 0.9999980461712802);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623334873e-07);
    AssertAlmostEqual(&test, rTM, 0.9999980462702773);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142474e-09);
    AssertAlmostEqual(&test, rTM, 0.9999980462712673);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999980462712773);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241549e-19);
    AssertAlmostEqual(&test, rTM, 0.9999980462712773);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9394123720811971);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154174786430217);
    AssertAlmostEqual(&test, rTM, 0.9567538913712645);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435713805220405);
    AssertAlmostEqual(&test, rTM, 0.997952736485924);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557792515350227);
    AssertAlmostEqual(&test, rTM, 0.9980490042998738);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090913614931e-06);
    AssertAlmostEqual(&test, rTM, 0.9980499911495077);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035836495e-10);
    AssertAlmostEqual(&test, rTM, 0.9980500011192539);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104037148856e-16);
    AssertAlmostEqual(&test, rTM, 0.998050001120251);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826588546233);
    AssertAlmostEqual(&test, rTM, 0.5398265885784981);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.539842720071124);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4235499341315477);
    AssertAlmostEqual(&test, rTM, 0.6386032524999031);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02404102492207204);
    AssertAlmostEqual(&test, rTM, 0.8286385677969029);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547689416465182);
    AssertAlmostEqual(&test, rTM, 0.8359481556132771);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242800337059e-08);
    AssertAlmostEqual(&test, rTM, 0.8360248656306843);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242955802115e-14);
    AssertAlmostEqual(&test, rTM, 0.8360248733054887);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697683515205767);
    AssertAlmostEqual(&test, rTM, 0.1697683515208177);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.1697684720120314);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1685721770971581);
    AssertAlmostEqual(&test, rTM, 0.1709640259154392);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.09979541861626358);
    AssertAlmostEqual(&test, rTM, 0.2380703813305414);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002426757452085647);
    AssertAlmostEqual(&test, rTM, 0.3278607801394779);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462960880822661e-07);
    AssertAlmostEqual(&test, rTM, 0.3300247375292281);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964557016787e-13);
    AssertAlmostEqual(&test, rTM, 0.3300249569994135);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0177540497287577);
    AssertAlmostEqual(&test, rTM, 0.01775404972875804);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775404955741153);
    AssertAlmostEqual(&test, rTM, 0.01775404990010421);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073257);
    AssertAlmostEqual(&test, rTM, 0.0177557630266789);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01758434176800727);
    AssertAlmostEqual(&test, rTM, 0.0179237566665308);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.009035315001121263);
    AssertAlmostEqual(&test, rTM, 0.02647008524563085);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.839974959587479e-06);
    AssertAlmostEqual(&test, rTM, 0.03549507295165378);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165728604144e-12);
    AssertAlmostEqual(&test, rTM, 0.03549691060647067);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592699611e-06);
    AssertAlmostEqual(&test, rTM, 6.38601059269961e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010592693225e-06);
    AssertAlmostEqual(&test, rTM, 6.386010592705996e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386010528840321e-06);
    AssertAlmostEqual(&test, rTM, 6.386010656558899e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386004206776965e-06);
    AssertAlmostEqual(&test, rTM, 6.386016978622255e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.385372063648604e-06);
    AssertAlmostEqual(&test, rTM, 6.386649121750616e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.193025686948003e-06);
    AssertAlmostEqual(&test, rTM, 9.578995498321003e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386085769576149e-12);
    AssertAlmostEqual(&test, rTM, 1.277201479879259e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248303e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248304e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248303e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672248238e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672248368e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357672241754e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672254853e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549357671593368e-12);
    AssertAlmostEqual(&test, rTM, 6.549357672903239e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549351122897181e-12);
    AssertAlmostEqual(&test, rTM, 6.549364221599426e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274678836145599e-12);
    AssertAlmostEqual(&test, rTM, 9.824036508351007e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 0.1/CAPS_hbar_eV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543454303076);
    AssertAlmostEqual(&test, rTM, 0.9980252209155606);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.102965699187465);
    AssertAlmostEqual(&test, rTM, 0.9999951955225214);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569244915241e-05);
    AssertAlmostEqual(&test, rTM, 0.9999960924502671);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664143347e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960925492652);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988345998e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960925502552);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620773e-19);
    AssertAlmostEqual(&test, rTM, 0.9999960925502652);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9154183088112393);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8825504004136473);
    AssertAlmostEqual(&test, rTM, 0.9393843384327727);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0124772036436392);
    AssertAlmostEqual(&test, rTM, 0.9960095063606029);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279248379435693);
    AssertAlmostEqual(&test, rTM, 0.9961066741387613);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573729689282e-06);
    AssertAlmostEqual(&test, rTM, 0.9961076582374928);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016780453e-10);
    AssertAlmostEqual(&test, rTM, 0.9961076681781765);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017109196e-16);
    AssertAlmostEqual(&test, rTM, 0.9961076681791707);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386404792);
    AssertAlmostEqual(&test, rTM, 0.4238840386747805);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838007);
    AssertAlmostEqual(&test, rTM, 0.4239011882275059);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3068221115102546);
    AssertAlmostEqual(&test, rTM, 0.5283123814249407);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01233461340918023);
    AssertAlmostEqual(&test, rTM, 0.7126260657185531);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276653162416125);
    AssertAlmostEqual(&test, rTM, 0.7185820852521931);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106846036755e-08);
    AssertAlmostEqual(&test, rTM, 0.7186438174392979);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891427817e-14);
    AssertAlmostEqual(&test, rTM, 0.7186438236147555);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.101355558466374);
    AssertAlmostEqual(&test, rTM, 0.1013555584665394);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.1013556411668453);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1005353155080313);
    AssertAlmostEqual(&test, rTM, 0.102175663648685);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05593061778999866);
    AssertAlmostEqual(&test, rTM, 0.146361774046572);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001239575725063476);
    AssertAlmostEqual(&test, rTM, 0.1994598852723253);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255079519801102e-07);
    AssertAlmostEqual(&test, rTM, 0.2006497307431778);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089924347e-13);
    AssertAlmostEqual(&test, rTM, 0.2006498511980167);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.01048140030973257);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.01048140041237206);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.01048242660518738);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01037975617409794);
    AssertAlmostEqual(&test, rTM, 0.01058304422876585);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.005295772450129483);
    AssertAlmostEqual(&test, rTM, 0.01566646446354114);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070352991556171e-06);
    AssertAlmostEqual(&test, rTM, 0.02095942802158984);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462318289852e-12);
    AssertAlmostEqual(&test, rTM, 0.02096049790328388);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487766e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246487765e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246481535e-06);
    AssertAlmostEqual(&test, rTM, 6.230539246493996e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23053918418315e-06);
    AssertAlmostEqual(&test, rTM, 6.23053930879238e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032388e-06);
    AssertAlmostEqual(&test, rTM, 6.230545476943142e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.229916262624602e-06);
    AssertAlmostEqual(&test, rTM, 6.231162230350928e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.115289033083767e-06);
    AssertAlmostEqual(&test, rTM, 9.345789459770832e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23061065576368e-12);
    AssertAlmostEqual(&test, rTM, 1.246107226188114e-05);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401203e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401204e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401203e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069401139e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069401269e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190069394655e-12);
    AssertAlmostEqual(&test, rTM, 6.549190069407753e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549190068746285e-12);
    AssertAlmostEqual(&test, rTM, 6.549190070056123e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549183520217684e-12);
    AssertAlmostEqual(&test, rTM, 6.549196618584723e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274595034722048e-12);
    AssertAlmostEqual(&test, rTM, 9.82378510408036e-12);

    userdata[0] = 0.01/CAPS_hbar_eV; /* 0.01eV */
    userdata[1] = 1/CAPS_hbar_eV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9875759613028289);
    AssertAlmostEqual(&test, rTM, 0.9937685045806279);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247864619925054);
    AssertAlmostEqual(&test, rTM, 0.9999599394154246);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959873924066e-06);
    AssertAlmostEqual(&test, rTM, 0.9999609267774318);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981371868e-08);
    AssertAlmostEqual(&test, rTM, 0.9999609268764259);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793284e-10);
    AssertAlmostEqual(&test, rTM, 0.9999609268774158);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999609268774258);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120773e-20);
    AssertAlmostEqual(&test, rTM, 0.9999609268774258);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149442);
    AssertAlmostEqual(&test, rTM, 0.7568049499443954);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6751528765943572);
    AssertAlmostEqual(&test, rTM, 0.820136825580926);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276207909877698);
    AssertAlmostEqual(&test, rTM, 0.9623003960648656);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279565490642007e-05);
    AssertAlmostEqual(&test, rTM, 0.9623937472174925);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599176354789e-07);
    AssertAlmostEqual(&test, rTM, 0.9623946820601379);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951659163e-11);
    AssertAlmostEqual(&test, rTM, 0.9623946915021835);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516625657e-17);
    AssertAlmostEqual(&test, rTM, 0.9623946915031277);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263662654);
    AssertAlmostEqual(&test, rTM, 0.1029494263830116);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029410539824989);
    AssertAlmostEqual(&test, rTM, 0.1029577987521907);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05689570980941892);
    AssertAlmostEqual(&test, rTM, 0.1485659548575681);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001263486356484799);
    AssertAlmostEqual(&test, rTM, 0.2025281513007322);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27919141579871e-05);
    AssertAlmostEqual(&test, rTM, 0.2037272414824166);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935204938754e-09);
    AssertAlmostEqual(&test, rTM, 0.2037395012126784);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065454527e-15);
    AssertAlmostEqual(&test, rTM, 0.2037395024389236);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.01245492462677815);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.01245493677524509);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01233461340918023);
    AssertAlmostEqual(&test, rTM, 0.0125752354837321);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.006305263369641244);
    AssertAlmostEqual(&test, rTM, 0.01860364383307662);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001264142596824081);
    AssertAlmostEqual(&test, rTM, 0.02477964946717012);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277105581702274e-08);
    AssertAlmostEqual(&test, rTM, 0.02490597294569249);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891426552e-14);
    AssertAlmostEqual(&test, rTM, 0.02490598570881356);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483430561);
    AssertAlmostEqual(&test, rTM, 0.001251940483430585);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940470942476);
    AssertAlmostEqual(&test, rTM, 0.00125194049591867);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251815614916913);
    AssertAlmostEqual(&test, rTM, 0.001252065351944194);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001239575725063476);
    AssertAlmostEqual(&test, rTM, 0.001264305241414857);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006267541641744386);
    AssertAlmostEqual(&test, rTM, 0.001877125824024964);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.25495527938387e-07);
    AssertAlmostEqual(&test, rTM, 0.002503751547655813);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081089800093e-13);
    AssertAlmostEqual(&test, rTM, 0.002503877042271502);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199222967e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199222966e-06);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218635e-06);
    AssertAlmostEqual(&test, rTM, 4.332115199227298e-06);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.33211515590219e-06);
    AssertAlmostEqual(&test, rTM, 4.332115242543742e-06);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149634e-06);
    AssertAlmostEqual(&test, rTM, 4.332119531296299e-06);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.331682034772543e-06);
    AssertAlmostEqual(&test, rTM, 4.332548363673391e-06);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.166066983232696e-06);
    AssertAlmostEqual(&test, rTM, 6.498163415172587e-06);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148401725135e-12);
    AssertAlmostEqual(&test, rTM, 8.664226066134927e-06);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684343149e-12);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617468434315e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684343149e-12);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174684343085e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684343215e-12);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174684336605e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684349696e-12);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546174683688533e-12);
    AssertAlmostEqual(&test, rTM, 6.546174684997767e-12);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546168138175012e-12);
    AssertAlmostEqual(&test, rTM, 6.546181230511287e-12);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273087342193001e-12);
    AssertAlmostEqual(&test, rTM, 9.819262026493298e-12);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 1e-05/CAPS_hbar_eV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046152864);
    AssertAlmostEqual(&test, rTM, 0.9999998023076235);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204596723029);
    AssertAlmostEqual(&test, rTM, 0.9999999997204209);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645672772);
    AssertAlmostEqual(&test, rTM, 0.9999999999972039);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829363016);
    AssertAlmostEqual(&test, rTM, 0.9999999999997177);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746377);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667342e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421808e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999608);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347648141);
    AssertAlmostEqual(&test, rTM, 0.9999903347744792);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999863313275121);
    AssertAlmostEqual(&test, rTM, 0.9999931656404016);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.999999903352055);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813140795321);
    AssertAlmostEqual(&test, rTM, 0.999999990334615);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9999999990323443);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0104814003097222);
    AssertAlmostEqual(&test, rTM, 0.9999999999523016);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481399e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999532911);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347385);
    AssertAlmostEqual(&test, rTM, 0.9995994585347785);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9995994785563187);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994335958248992);
    AssertAlmostEqual(&test, rTM, 0.9997167577936957);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610084);
    AssertAlmostEqual(&test, rTM, 0.9999601373656802);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9999959931877275);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175928);
    AssertAlmostEqual(&test, rTM, 0.9999999103068665);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.2306161100403e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999197511207);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902135376067);
    AssertAlmostEqual(&test, rTM, 0.9960902135376106);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902115865451);
    AssertAlmostEqual(&test, rTM, 0.9960902154886713);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207765);
    AssertAlmostEqual(&test, rTM, 0.996109579245716);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944752111970168);
    AssertAlmostEqual(&test, rTM, 0.9972337743118063);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613974606664578);
    AssertAlmostEqual(&test, rTM, 0.9996102009068102);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784156596710272);
    AssertAlmostEqual(&test, rTM, 0.9999913846969479);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516172002854603e-08);
    AssertAlmostEqual(&test, rTM, 0.999992326842152);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184991);
    AssertAlmostEqual(&test, rTM, 0.9616716943184993);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716941306022);
    AssertAlmostEqual(&test, rTM, 0.9616716945063962);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9616735731505945);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9614842830471968);
    AssertAlmostEqual(&test, rTM, 0.9618582114092465);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462324651839);
    AssertAlmostEqual(&test, rTM, 0.9727396793627803);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.9991427070922716);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173826726316e-08);
    AssertAlmostEqual(&test, rTM, 0.9992367779985699);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014005664);
    AssertAlmostEqual(&test, rTM, 0.05810489014005663);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810489014000492);
    AssertAlmostEqual(&test, rTM, 0.05810489014010835);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810488962282331);
    AssertAlmostEqual(&test, rTM, 0.05810489065728996);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676956);
    AssertAlmostEqual(&test, rTM, 0.0581049418633434);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05809971826867313);
    AssertAlmostEqual(&test, rTM, 0.05811006200832121);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076359202774576);
    AssertAlmostEqual(&test, rTM, 0.08535929875011761);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549484353388131e-08);
    AssertAlmostEqual(&test, rTM, 0.115818690899553);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.54952439231117e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311171e-08);
    AssertAlmostEqual(&test, rTM, 6.54952439231117e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392311106e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392311236e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524392304621e-08);
    AssertAlmostEqual(&test, rTM, 6.54952439231772e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549524391656219e-08);
    AssertAlmostEqual(&test, rTM, 6.549524392966122e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549517842794187e-08);
    AssertAlmostEqual(&test, rTM, 6.549530941828155e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274762410636937e-08);
    AssertAlmostEqual(&test, rTM, 9.824286373985389e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 0.001/CAPS_hbar_eV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996046542216);
    AssertAlmostEqual(&test, rTM, 0.9999980232691541);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135505);
    AssertAlmostEqual(&test, rTM, 0.9999999972044763);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451692128);
    AssertAlmostEqual(&test, rTM, 0.9999999999717729);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209568222);
    AssertAlmostEqual(&test, rTM, 0.9999999999951954);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310102);
    AssertAlmostEqual(&test, rTM, 0.9999999999960825);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951662533e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639868);
    AssertAlmostEqual(&test, rTM, 0.9999115155524672);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249645);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911897851734701);
    AssertAlmostEqual(&test, rTM, 0.9999991151519048);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237413);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135127);
    AssertAlmostEqual(&test, rTM, 0.999999996083901);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101662e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960849009);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339392687897);
    AssertAlmostEqual(&test, rTM, 0.9990339392688862);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689123);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903335780866971);
    AssertAlmostEqual(&test, rTM, 0.9999038304114182);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140020709287);
    AssertAlmostEqual(&test, rTM, 0.9999995230171358);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295481388e-08);
    AssertAlmostEqual(&test, rTM, 0.9999995329123047);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010393);
    AssertAlmostEqual(&test, rTM, 0.9952070286010439);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103135);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995183181070751);
    AssertAlmostEqual(&test, rTM, 0.9952307583471077);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935593);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9528670140848166);
    AssertAlmostEqual(&test, rTM, 0.9995219122380034);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880098);
    AssertAlmostEqual(&test, rTM, 0.9999874984760787);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332152358555834e-08);
    AssertAlmostEqual(&test, rTM, 0.999988458526204);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946346);
    AssertAlmostEqual(&test, rTM, 0.960732281594635);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172676);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9605403730769471);
    AssertAlmostEqual(&test, rTM, 0.9609232753844564);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727583);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.9991038390080457);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230616109417301e-08);
    AssertAlmostEqual(&test, rTM, 0.9991981546150349);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950604);
    AssertAlmostEqual(&test, rTM, 0.05807869275950604);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945434);
    AssertAlmostEqual(&test, rTM, 0.05807869275955774);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869224247873);
    AssertAlmostEqual(&test, rTM, 0.05807869327653335);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219071);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807352294817292);
    AssertAlmostEqual(&test, rTM, 0.05808386256772412);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813653);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54616728121451e-08);
    AssertAlmostEqual(&test, rTM, 0.1157668236439184);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522593e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073522595e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073522593e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54952107352253e-08);
    AssertAlmostEqual(&test, rTM, 6.54952107352266e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521073516046e-08);
    AssertAlmostEqual(&test, rTM, 6.549521073529143e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549521072867644e-08);
    AssertAlmostEqual(&test, rTM, 6.549521074177546e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514524008929e-08);
    AssertAlmostEqual(&test, rTM, 6.54952762303626e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274760751242432e-08);
    AssertAlmostEqual(&test, rTM, 9.824281395802743e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 0.003/CAPS_hbar_eV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999931524246207);
    AssertAlmostEqual(&test, rTM, 0.9999965762064491);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697222398384);
    AssertAlmostEqual(&test, rTM, 0.9999999951580046);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937695254);
    AssertAlmostEqual(&test, rTM, 0.9999999999501813);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359489515);
    AssertAlmostEqual(&test, rTM, 0.9999999999873169);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566085);
    AssertAlmostEqual(&test, rTM, 0.9999999999882675);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764603e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999882775);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337277626242e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999882775);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468448881994);
    AssertAlmostEqual(&test, rTM, 0.9998468450413426);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997834129426901);
    AssertAlmostEqual(&test, rTM, 0.9998917006066481);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9847994205002515);
    AssertAlmostEqual(&test, rTM, 0.9999984683651936);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581146926036658);
    AssertAlmostEqual(&test, rTM, 0.9999998463848182);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2437694757417722);
    AssertAlmostEqual(&test, rTM, 0.9999999807076662);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262200735122688e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999882689712);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564085095607e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999882699712);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984210070371003);
    AssertAlmostEqual(&test, rTM, 0.998421007037258);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998420928151886);
    AssertAlmostEqual(&test, rTM, 0.9984210859185346);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9977676974412568);
    AssertAlmostEqual(&test, rTM, 0.9988832247791695);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9842443799871644);
    AssertAlmostEqual(&test, rTM, 0.9998427676415058);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539624803798709);
    AssertAlmostEqual(&test, rTM, 0.9999841492628978);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00397279103028709);
    AssertAlmostEqual(&test, rTM, 0.9999987414604169);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004546285293059e-09);
    AssertAlmostEqual(&test, rTM, 0.9999987514206602);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973434863488);
    AssertAlmostEqual(&test, rTM, 0.9937973434863548);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973403946726);
    AssertAlmostEqual(&test, rTM, 0.9937973465780295);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937665040725735);
    AssertAlmostEqual(&test, rTM, 0.9938280307984377);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9912394152515813);
    AssertAlmostEqual(&test, rTM, 0.9956100506948775);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9393943011456484);
    AssertAlmostEqual(&test, rTM, 0.9993807848077312);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457694870135704);
    AssertAlmostEqual(&test, rTM, 0.9999796684455321);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583106697803545e-08);
    AssertAlmostEqual(&test, rTM, 0.9999806438378118);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038392938307);
    AssertAlmostEqual(&test, rTM, 0.9589038392938309);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589038390926609);
    AssertAlmostEqual(&test, rTM, 0.9589038394950008);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589018276463681);
    AssertAlmostEqual(&test, rTM, 0.9589058508448943);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9587031909474285);
    AssertAlmostEqual(&test, rTM, 0.9591035331073803);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9423840556023857);
    AssertAlmostEqual(&test, rTM, 0.9707583375657195);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.051115842111036);
    AssertAlmostEqual(&test, rTM, 0.9990253875325809);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.677700845222079e-08);
    AssertAlmostEqual(&test, rTM, 0.999120136685718);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584100262816);
    AssertAlmostEqual(&test, rTM, 0.05802584100262815);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0580258410025765);
    AssertAlmostEqual(&test, rTM, 0.05802584100267981);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802584048601656);
    AssertAlmostEqual(&test, rTM, 0.05802584151923975);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802578934151381);
    AssertAlmostEqual(&test, rTM, 0.05802589266374218);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802067534803731);
    AssertAlmostEqual(&test, rTM, 0.05803100665411181);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03071938549486962);
    AssertAlmostEqual(&test, rTM, 0.08524574630240679);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539476365059379e-08);
    AssertAlmostEqual(&test, rTM, 0.115662182903661);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951436890947e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951436890947e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909469e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368909404e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368909534e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54951436890292e-08);
    AssertAlmostEqual(&test, rTM, 6.549514368916017e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549514368254518e-08);
    AssertAlmostEqual(&test, rTM, 6.54951436956442e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549507819402508e-08);
    AssertAlmostEqual(&test, rTM, 6.549520918416429e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27475739893543e-08);
    AssertAlmostEqual(&test, rTM, 9.824271338883493e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 0.035/CAPS_hbar_eV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999766112778122);
    AssertAlmostEqual(&test, rTM, 0.9999883055705258);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.983597670228356);
    AssertAlmostEqual(&test, rTM, 0.9999999834609254);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488747920721);
    AssertAlmostEqual(&test, rTM, 0.9999999997853936);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668030816);
    AssertAlmostEqual(&test, rTM, 0.9999999998622423);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590494e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998632286);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998632386);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557691988e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999998632386);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771280641538);
    AssertAlmostEqual(&test, rTM, 0.9994771285868883);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992606278786517);
    AssertAlmostEqual(&test, rTM, 0.9996302455675199);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490464858594957);
    AssertAlmostEqual(&test, rTM, 0.9999947684032061);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961732073415468);
    AssertAlmostEqual(&test, rTM, 0.9999994594048877);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410679030011442);
    AssertAlmostEqual(&test, rTM, 0.9999998535721821);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962000996e-06);
    AssertAlmostEqual(&test, rTM, 0.999999863230112);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801691505644e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998632311121);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947692194635982);
    AssertAlmostEqual(&test, rTM, 0.9947692194641198);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947689586172078);
    AssertAlmostEqual(&test, rTM, 0.9947694802975371);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992610589733697);
    AssertAlmostEqual(&test, rTM, 0.9962984314061427);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9486639769323799);
    AssertAlmostEqual(&test, rTM, 0.9994781098849984);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953265798408696);
    AssertAlmostEqual(&test, rTM, 0.9999457860780718);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003633069571820349);
    AssertAlmostEqual(&test, rTM, 0.9999862377243132);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635710883741431e-10);
    AssertAlmostEqual(&test, rTM, 0.9999862477204637);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499352263409);
    AssertAlmostEqual(&test, rTM, 0.9831499352263575);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499268729033);
    AssertAlmostEqual(&test, rTM, 0.983149943579791);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9830666120897826);
    AssertAlmostEqual(&test, rTM, 0.9832328518262502);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9762541272309364);
    AssertAlmostEqual(&test, rTM, 0.9880553022796092);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8431763385071424);
    AssertAlmostEqual(&test, rTM, 0.9983044562389719);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438935276602306);
    AssertAlmostEqual(&test, rTM, 0.9998546290897512);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462713838251311e-09);
    AssertAlmostEqual(&test, rTM, 0.9998556254325166);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118494083757);
    AssertAlmostEqual(&test, rTM, 0.9368118494083761);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368118491027427);
    AssertAlmostEqual(&test, rTM, 0.9368118497140091);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368087931574401);
    AssertAlmostEqual(&test, rTM, 0.936814905516318);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9365070268674252);
    AssertAlmostEqual(&test, rTM, 0.9371152560529851);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9118376389819565);
    AssertAlmostEqual(&test, rTM, 0.9548784534056387);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224203290649635);
    AssertAlmostEqual(&test, rTM, 0.997776072916471);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346286630400464e-08);
    AssertAlmostEqual(&test, rTM, 0.9978735046867089);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937207796);
    AssertAlmostEqual(&test, rTM, 0.05719314937207796);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314937202696);
    AssertAlmostEqual(&test, rTM, 0.05719314937212896);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719314886202838);
    AssertAlmostEqual(&test, rTM, 0.05719314988212754);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719309836716479);
    AssertAlmostEqual(&test, rTM, 0.05719320037699083);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05718804933251204);
    AssertAlmostEqual(&test, rTM, 0.05719824940865888);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03025411464288586);
    AssertAlmostEqual(&test, rTM, 0.08404915689634287);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434251946686054e-08);
    AssertAlmostEqual(&test, rTM, 0.1140132911320524);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966268e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966269e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966268e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096966204e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096966334e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096959719e-08);
    AssertAlmostEqual(&test, rTM, 6.549407096972818e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549407096311329e-08);
    AssertAlmostEqual(&test, rTM, 6.549407097621208e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54940054756658e-08);
    AssertAlmostEqual(&test, rTM, 6.549413646365957e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274703762956804e-08);
    AssertAlmostEqual(&test, rTM, 9.824110430975719e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 0.05/CAPS_hbar_eV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451941632);
    AssertAlmostEqual(&test, rTM, 0.9999860224993955);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270890153469);
    AssertAlmostEqual(&test, rTM, 0.9999999802317355);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057035822);
    AssertAlmostEqual(&test, rTM, 0.9999999997220694);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095569111);
    AssertAlmostEqual(&test, rTM, 0.9999999998036292);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55907295112627e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998046167);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933241536e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999998046267);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750856388055);
    AssertAlmostEqual(&test, rTM, 0.9993750862635238);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163524851087);
    AssertAlmostEqual(&test, rTM, 0.9995580785737093);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394094080675028);
    AssertAlmostEqual(&test, rTM, 0.9999937461859376);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404490820487861);
    AssertAlmostEqual(&test, rTM, 0.9999993450689395);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945769041677);
    AssertAlmostEqual(&test, rTM, 0.9999997948627553);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55909093920315e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998046181576);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.55910403713576e-12);
    AssertAlmostEqual(&test, rTM, 0.9999998046191576);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.993756410269403);
    AssertAlmostEqual(&test, rTM, 0.9937564102700253);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9937567214482986);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911816767135825);
    AssertAlmostEqual(&test, rTM, 0.995581053287666);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.939005708744943);
    AssertAlmostEqual(&test, rTM, 0.9993766828974835);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5398104566570995);
    AssertAlmostEqual(&test, rTM, 0.9999343747780592);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002547944030146036);
    AssertAlmostEqual(&test, rTM, 0.9999803767214865);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242954502518e-10);
    AssertAlmostEqual(&test, rTM, 0.9999803867186343);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9800521764661692);
    AssertAlmostEqual(&test, rTM, 0.9800521764661888);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980052166592751);
    AssertAlmostEqual(&test, rTM, 0.9800521863396022);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9801501812086754);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9719069902716758);
    AssertAlmostEqual(&test, rTM, 0.9858527196718201);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8169653078376536);
    AssertAlmostEqual(&test, rTM, 0.9979870005950631);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450903921987279);
    AssertAlmostEqual(&test, rTM, 0.9997960365723073);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462964544885611e-09);
    AssertAlmostEqual(&test, rTM, 0.9997970338152267);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494298690386);
    AssertAlmostEqual(&test, rTM, 0.9289494298690393);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289494295268714);
    AssertAlmostEqual(&test, rTM, 0.9289494302112065);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9289460082856721);
    AssertAlmostEqual(&test, rTM, 0.9289528512937092);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9286081773572921);
    AssertAlmostEqual(&test, rTM, 0.9292891110018014);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.901040242421558);
    AssertAlmostEqual(&test, rTM, 0.949197853542339);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01775233643073257);
    AssertAlmostEqual(&test, rTM, 0.9971924050051805);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840165660886721e-08);
    AssertAlmostEqual(&test, rTM, 0.9972902162089078);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0568110235581803);
    AssertAlmostEqual(&test, rTM, 0.05681102355818029);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102355812959);
    AssertAlmostEqual(&test, rTM, 0.056811023558231);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681102305114991);
    AssertAlmostEqual(&test, rTM, 0.05681102406521069);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681097285518611);
    AssertAlmostEqual(&test, rTM, 0.05681107426117418);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05680595370816383);
    AssertAlmostEqual(&test, rTM, 0.05681609340526683);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0300408407178514);
    AssertAlmostEqual(&test, rTM, 0.08349976485649359);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386084954016015e-08);
    AssertAlmostEqual(&test, rTM, 0.1132564495413013);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452513e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452514e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452513e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814452449e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814452579e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356814445965e-08);
    AssertAlmostEqual(&test, rTM, 6.549356814459063e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549356813797579e-08);
    AssertAlmostEqual(&test, rTM, 6.549356815107448e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549350265103107e-08);
    AssertAlmostEqual(&test, rTM, 6.54936336380192e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274678621696634e-08);
    AssertAlmostEqual(&test, rTM, 9.824035007208378e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 0.1/CAPS_hbar_eV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661637284);
    AssertAlmostEqual(&test, rTM, 0.9999802328864927);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328058863567);
    AssertAlmostEqual(&test, rTM, 0.9999999720420873);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829203601);
    AssertAlmostEqual(&test, rTM, 0.99999999951955);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667696434);
    AssertAlmostEqual(&test, rTM, 0.9999999996082547);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043182e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996092435);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960198834601e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960199162077e-15);
    AssertAlmostEqual(&test, rTM, 0.9999999996092535);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714283);
    AssertAlmostEqual(&test, rTM, 0.999116361554676);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987505746781754);
    AssertAlmostEqual(&test, rTM, 0.9993750920231087);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154142261610254);
    AssertAlmostEqual(&test, rTM, 0.9999911515551388);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242152642895281);
    AssertAlmostEqual(&test, rTM, 0.9999990334623692);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842048689627);
    AssertAlmostEqual(&test, rTM, 0.999999599370816);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742483706e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996092450258);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577017105922e-12);
    AssertAlmostEqual(&test, rTM, 0.9999996092460258);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237018977);
    AssertAlmostEqual(&test, rTM, 0.9911902237027747);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911897851734701);
    AssertAlmostEqual(&test, rTM, 0.9911906622094709);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.98756390651418);
    AssertAlmostEqual(&test, rTM, 0.99376243919542);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.999119042917794);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238668887838007);
    AssertAlmostEqual(&test, rTM, 0.9999032480337134);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780782371855);
    AssertAlmostEqual(&test, rTM, 0.999960840543927);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891101649e-10);
    AssertAlmostEqual(&test, rTM, 0.9999608505420529);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095646991);
    AssertAlmostEqual(&test, rTM, 0.9721686095647265);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454005);
    AssertAlmostEqual(&test, rTM, 0.9721686232840184);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843617);
    AssertAlmostEqual(&test, rTM, 0.9723047916104839);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608698610186749);
    AssertAlmostEqual(&test, rTM, 0.9802377476940242);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.9971677816664117);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251939234622125);
    AssertAlmostEqual(&test, rTM, 0.9996007798601301);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086774204e-09);
    AssertAlmostEqual(&test, rTM, 0.999601778009189);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310883635);
    AssertAlmostEqual(&test, rTM, 0.9079053108836357);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9079053113218817);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9079096930284706);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9074682624586706);
    AssertAlmostEqual(&test, rTM, 0.9083403942244028);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8723352451542481);
    AssertAlmostEqual(&test, rTM, 0.9339146140361048);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048037401425547);
    AssertAlmostEqual(&test, rTM, 0.9952525883422696);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070462295374353e-08);
    AssertAlmostEqual(&test, rTM, 0.9953508365460541);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897763);
    AssertAlmostEqual(&test, rTM, 0.05557345736897762);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0555734573689279);
    AssertAlmostEqual(&test, rTM, 0.05557345736902734);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345687175929);
    AssertAlmostEqual(&test, rTM, 0.05557345786619595);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718827);
    AssertAlmostEqual(&test, rTM, 0.0555735070907667);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05556848563178084);
    AssertAlmostEqual(&test, rTM, 0.05557842910341854);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02935116395116614);
    AssertAlmostEqual(&test, rTM, 0.08171931191298329);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.23060987943126e-08);
    AssertAlmostEqual(&test, rTM, 0.1108046429321275);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649318e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649318e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649316e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211649251e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211649381e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189211642768e-08);
    AssertAlmostEqual(&test, rTM, 6.549189211655865e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549189210994398e-08);
    AssertAlmostEqual(&test, rTM, 6.549189212304234e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549182662467512e-08);
    AssertAlmostEqual(&test, rTM, 6.549195760831121e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274594820284059e-08);
    AssertAlmostEqual(&test, rTM, 9.823783603014559e-08);

    userdata[0] = 1/CAPS_hbar_eV; /* 1eV */
    userdata[1] = 1/CAPS_hbar_eV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749883772485);
    AssertAlmostEqual(&test, rTM, 0.9999374922349528);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190176392103);
    AssertAlmostEqual(&test, rTM, 0.9999999115116414);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865836908448);
    AssertAlmostEqual(&test, rTM, 0.9999999959937829);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642578887);
    AssertAlmostEqual(&test, rTM, 0.9999999960915351);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368607e-06);
    AssertAlmostEqual(&test, rTM, 0.999999996092525);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.999999996092535);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014120772e-16);
    AssertAlmostEqual(&test, rTM, 0.999999996092535);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135505);
    AssertAlmostEqual(&test, rTM, 0.9972083838012645);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960543416220194);
    AssertAlmostEqual(&test, rTM, 0.9980252190076432);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.756794369041208);
    AssertAlmostEqual(&test, rTM, 0.9999717748496368);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029655372157411);
    AssertAlmostEqual(&test, rTM, 0.9999951955148016);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335192579302);
    AssertAlmostEqual(&test, rTM, 0.9999960825555295);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189149498e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960925417074);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951662533e-13);
    AssertAlmostEqual(&test, rTM, 0.9999960925427075);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645672772);
    AssertAlmostEqual(&test, rTM, 0.9724301645699954);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798037);
    AssertAlmostEqual(&test, rTM, 0.9724315236914008);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612354409672108);
    AssertAlmostEqual(&test, rTM, 0.9804242595326388);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7557402413855081);
    AssertAlmostEqual(&test, rTM, 0.9971952513949729);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029410539824989);
    AssertAlmostEqual(&test, rTM, 0.9995196894985151);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319318874477e-05);
    AssertAlmostEqual(&test, rTM, 0.9996093198547285);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352065421796e-11);
    AssertAlmostEqual(&test, rTM, 0.9996093298487312);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070082);
    AssertAlmostEqual(&test, rTM, 0.915340124407089);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9153401648659328);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.9157417864519122);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8824439617548145);
    AssertAlmostEqual(&test, rTM, 0.9393275245237456);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4221773770615926);
    AssertAlmostEqual(&test, rTM, 0.9904287359880045);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276779518682876);
    AssertAlmostEqual(&test, rTM, 0.9960991751269493);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106891100385e-10);
    AssertAlmostEqual(&test, rTM, 0.9961001691553921);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710571431521);
    AssertAlmostEqual(&test, rTM, 0.7547710571431541);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547710560883619);
    AssertAlmostEqual(&test, rTM, 0.7547710581979442);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.7547816043224577);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7537196740938393);
    AssertAlmostEqual(&test, rTM, 0.7558185767346892);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6726128163531534);
    AssertAlmostEqual(&test, rTM, 0.818548272705538);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251815614916913);
    AssertAlmostEqual(&test, rTM, 0.9615940097706075);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255081086649951e-09);
    AssertAlmostEqual(&test, rTM, 0.9616882042740025);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986313606);
    AssertAlmostEqual(&test, rTM, 0.03993086986313606);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399308698630992);
    AssertAlmostEqual(&test, rTM, 0.03993086986317292);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086949449237);
    AssertAlmostEqual(&test, rTM, 0.03993087023177974);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880098);
    AssertAlmostEqual(&test, rTM, 0.03993090672747102);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0399271837670649);
    AssertAlmostEqual(&test, rTM, 0.03993455595812039);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02077030683011267);
    AssertAlmostEqual(&test, rTM, 0.05906211159647557);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332148026412515e-08);
    AssertAlmostEqual(&test, rTM, 0.07973456189638718);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380934e-08);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827380935e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827380934e-08);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54617382738087e-08);
    AssertAlmostEqual(&test, rTM, 6.546173827381e-08);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173827374389e-08);
    AssertAlmostEqual(&test, rTM, 6.54617382738748e-08);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546173826726318e-08);
    AssertAlmostEqual(&test, rTM, 6.546173828035551e-08);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546167281214511e-08);
    AssertAlmostEqual(&test, rTM, 6.546180373547358e-08);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.27308712795243e-08);
    AssertAlmostEqual(&test, rTM, 9.819260526809425e-08);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 1e-05/CAPS_hbar_eV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604615216);
    AssertAlmostEqual(&test, rTM, 0.9999999802307605);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424500917);
    AssertAlmostEqual(&test, rTM, 0.999999999972042);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128215705);
    AssertAlmostEqual(&test, rTM, 0.9999999999997203);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686227);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364054);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089014522639);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27935206218106e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334722777);
    AssertAlmostEqual(&test, rTM, 0.9999990334732441);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986331243437);
    AssertAlmostEqual(&test, rTM, 0.9999993165619382);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680954);
    AssertAlmostEqual(&test, rTM, 0.9999999903352061);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990339387860412);
    AssertAlmostEqual(&test, rTM, 0.9999999990334726);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990381318817769);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136762640156);
    AssertAlmostEqual(&test, rTM, 0.9999999999989265);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626173e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999995328);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318708);
    AssertAlmostEqual(&test, rTM, 0.9999599386318747);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288946);
    AssertAlmostEqual(&test, rTM, 0.9999599406347508);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999433451399429);
    AssertAlmostEqual(&test, rTM, 0.9999716721687327);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9999960136728986);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848566);
    AssertAlmostEqual(&test, rTM, 0.9999995993976001);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.9999999959141997);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539246487703e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999991975012);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083315083162);
    AssertAlmostEqual(&test, rTM, 0.9996083315083165);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996083313125206);
    AssertAlmostEqual(&test, rTM, 0.999608331704112);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219265);
    AssertAlmostEqual(&test, rTM, 0.9996102749056973);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994461420451363);
    AssertAlmostEqual(&test, rTM, 0.999723032661804);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960707516207765);
    AssertAlmostEqual(&test, rTM, 0.9999610205797513);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6775426753688117);
    AssertAlmostEqual(&test, rTM, 0.9999996008109355);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.516087932430736e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999232668486);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865776);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657671118);
    AssertAlmostEqual(&test, rTM, 0.9960991658060437);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.9960993604325529);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960797483438886);
    AssertAlmostEqual(&test, rTM, 0.9961184872395348);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944878510614401);
    AssertAlmostEqual(&test, rTM, 0.9972401117910541);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.9999601788813732);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370826e-06);
    AssertAlmostEqual(&test, rTM, 0.9999923619097997);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560479311);
    AssertAlmostEqual(&test, rTM, 0.678206556047931);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065560478011);
    AssertAlmostEqual(&test, rTM, 0.6782065560480611);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782065547474808);
    AssertAlmostEqual(&test, rTM, 0.6782065573483813);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6782064260029464);
    AssertAlmostEqual(&test, rTM, 0.6782066860928733);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781935520065664);
    AssertAlmostEqual(&test, rTM, 0.6782195596645668);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5793778480571924);
    AssertAlmostEqual(&test, rTM, 0.7573816987141846);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549399421194755e-06);
    AssertAlmostEqual(&test, rTM, 0.9290720048849316);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079368e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079369e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079368e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439459079304e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459079434e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54943945907282e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459085918e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549439458424434e-06);
    AssertAlmostEqual(&test, rTM, 6.549439459734304e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549432909732249e-06);
    AssertAlmostEqual(&test, rTM, 6.549446008426488e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274741177153416e-06);
    AssertAlmostEqual(&test, rTM, 9.824137740864854e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 0.001/CAPS_hbar_eV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046535183);
    AssertAlmostEqual(&test, rTM, 0.9999998023267396);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204866988281);
    AssertAlmostEqual(&test, rTM, 0.9999999997204478);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327931884105);
    AssertAlmostEqual(&test, rTM, 0.9999999999972041);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451795845);
    AssertAlmostEqual(&test, rTM, 0.9999999999997177);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209569051);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770174752e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599516592909e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999991151194048);
    AssertAlmostEqual(&test, rTM, 0.9999911512028967);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999987485927803);
    AssertAlmostEqual(&test, rTM, 0.999993742944326);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514828);
    AssertAlmostEqual(&test, rTM, 0.9999999115160125);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902193169381);
    AssertAlmostEqual(&test, rTM, 0.9999999911510771);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024596);
    AssertAlmostEqual(&test, rTM, 0.9999999991142502);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492462675385);
    AssertAlmostEqual(&test, rTM, 0.9999999999598614);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858807823e-08);
    AssertAlmostEqual(&test, rTM, 0.999999999960849);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033519001411);
    AssertAlmostEqual(&test, rTM, 0.9999033519001508);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680954);
    AssertAlmostEqual(&test, rTM, 0.999903356731955);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823869);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990291233210521);
    AssertAlmostEqual(&test, rTM, 0.9999903827350038);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3936136745515031);
    AssertAlmostEqual(&test, rTM, 0.9999999892652578);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026626162e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999953291109);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196654879897);
    AssertAlmostEqual(&test, rTM, 0.9995196654879901);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995196652478804);
    AssertAlmostEqual(&test, rTM, 0.9995196657280992);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.9995220487269983);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999320772008197);
    AssertAlmostEqual(&test, rTM, 0.9996603283058726);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995183181070751);
    AssertAlmostEqual(&test, rTM, 0.999952194452884);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.9999995058819904);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332115199218635e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998845829532);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894189);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848566);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9959818986610084);
    AssertAlmostEqual(&test, rTM, 0.9960216025466186);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.9999591449603745);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230539245864719e-06);
    AssertAlmostEqual(&test, rTM, 0.9999919750768309);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715081519);
    AssertAlmostEqual(&test, rTM, 0.6781406715081518);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406715080218);
    AssertAlmostEqual(&test, rTM, 0.6781406715082818);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781406702075107);
    AssertAlmostEqual(&test, rTM, 0.6781406728087931);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781405414440712);
    AssertAlmostEqual(&test, rTM, 0.6781408015721899);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6781276655572938);
    AssertAlmostEqual(&test, rTM, 0.6781536770342678);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5792996766992881);
    AssertAlmostEqual(&test, rTM, 0.7573278352224875);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028693e-06);
    AssertAlmostEqual(&test, rTM, 0.929038615098604);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376867e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376868e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376867e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140376802e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140376932e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436140370318e-06);
    AssertAlmostEqual(&test, rTM, 6.549436140383416e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549436139721932e-06);
    AssertAlmostEqual(&test, rTM, 6.549436141031802e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429591033066e-06);
    AssertAlmostEqual(&test, rTM, 6.549442689720668e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274739517780429e-06);
    AssertAlmostEqual(&test, rTM, 9.824132762832836e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 0.003/CAPS_hbar_eV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993152403521);
    AssertAlmostEqual(&test, rTM, 0.9999996576201173);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995159186115137);
    AssertAlmostEqual(&test, rTM, 0.9999999995158018);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167639209);
    AssertAlmostEqual(&test, rTM, 0.9999999999951565);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937839459);
    AssertAlmostEqual(&test, rTM, 0.9999999999995017);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359493118);
    AssertAlmostEqual(&test, rTM, 0.9999999999998731);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265300891810416e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26533727759022e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999998828);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846834331608);
    AssertAlmostEqual(&test, rTM, 0.9999846834484771);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999783391829896);
    AssertAlmostEqual(&test, rTM, 0.9999891695328449);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984694284414072);
    AssertAlmostEqual(&test, rTM, 0.9999998468408597);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9848001671105664);
    AssertAlmostEqual(&test, rTM, 0.9999999846828821);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8581147574738499);
    AssertAlmostEqual(&test, rTM, 0.9999999984638472);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00422660785908485);
    AssertAlmostEqual(&test, rTM, 0.9999999998817038);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262564049120091e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999998826996);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998419883802633);
    AssertAlmostEqual(&test, rTM, 0.9998419883802789);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999841980480512);
    AssertAlmostEqual(&test, rTM, 0.9998419962796354);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997765451376869);
    AssertAlmostEqual(&test, rTM, 0.9998882663262877);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984131379651795);
    AssertAlmostEqual(&test, rTM, 0.999984276132615);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843211766384766);
    AssertAlmostEqual(&test, rTM, 0.9999984197898859);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2346007450760938);
    AssertAlmostEqual(&test, rTM, 0.999999979860199);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004543110090811e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999875141812);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779952411924);
    AssertAlmostEqual(&test, rTM, 0.999377995241193);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993779949302872);
    AssertAlmostEqual(&test, rTM, 0.9993779955520981);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999374893923756);
    AssertAlmostEqual(&test, rTM, 0.9993810811769321);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991204657796154);
    AssertAlmostEqual(&test, rTM, 0.9995601361284233);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937665040725735);
    AssertAlmostEqual(&test, rTM, 0.9999380905756214);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.541953146454444);
    AssertAlmostEqual(&test, rTM, 0.9999993483885212);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.583093486456729e-06);
    AssertAlmostEqual(&test, rTM, 0.9999998064336788);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958120411189249);
    AssertAlmostEqual(&test, rTM, 0.9958120411189247);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995812041098029);
    AssertAlmostEqual(&test, rTM, 0.9958120411398206);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958118321656215);
    AssertAlmostEqual(&test, rTM, 0.9958122500618249);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9957911974624619);
    AssertAlmostEqual(&test, rTM, 0.995832781764885);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9940824773433514);
    AssertAlmostEqual(&test, rTM, 0.9970368420244319);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6592346369026727);
    AssertAlmostEqual(&test, rTM, 0.9999571215985529);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -5.67763701827458e-06);
    AssertAlmostEqual(&test, rTM, 0.9999911935969991);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436899776);
    AssertAlmostEqual(&test, rTM, 0.6780076436899775);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076436898475);
    AssertAlmostEqual(&test, rTM, 0.6780076436901076);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780076423889508);
    AssertAlmostEqual(&test, rTM, 0.6780076449910042);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6780075135873513);
    AssertAlmostEqual(&test, rTM, 0.6780077737925612);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6779946338847714);
    AssertAlmostEqual(&test, rTM, 0.6780206530704149);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5791418515671608);
    AssertAlmostEqual(&test, rTM, 0.757219072269589);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.539391692228124e-06);
    AssertAlmostEqual(&test, rTM, 0.9289711683059247);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54942943593763e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54942943593763e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937629e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435937563e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435937694e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54942943593108e-06);
    AssertAlmostEqual(&test, rTM, 6.549429435944178e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549429435282695e-06);
    AssertAlmostEqual(&test, rTM, 6.549429436592563e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549422886600532e-06);
    AssertAlmostEqual(&test, rTM, 6.549435985274726e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274736165516899e-06);
    AssertAlmostEqual(&test, rTM, 9.82412270621789e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 0.035/CAPS_hbar_eV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999976611031643);
    AssertAlmostEqual(&test, rTM, 0.9999988305508983);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983475144747019);
    AssertAlmostEqual(&test, rTM, 0.9999999983461485);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264594536101);
    AssertAlmostEqual(&test, rTM, 0.9999999999834049);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488748060495);
    AssertAlmostEqual(&test, rTM, 0.9999999999978538);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668034383);
    AssertAlmostEqual(&test, rTM, 0.9999999999986223);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.65600288441913e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999986323);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557689341e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999986323);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999947700498972);
    AssertAlmostEqual(&test, rTM, 0.9999477005512699);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999260381744695);
    AssertAlmostEqual(&test, rTM, 0.9999630184034027);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947833146201699);
    AssertAlmostEqual(&test, rTM, 0.9999994770160716);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.949048941939528);
    AssertAlmostEqual(&test, rTM, 0.9999999476813052);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961733566630992);
    AssertAlmostEqual(&test, rTM, 0.9999999945940445);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003653131154797861);
    AssertAlmostEqual(&test, rTM, 0.9999999986313113);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801688859396e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999986323109);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756860092723);
    AssertAlmostEqual(&test, rTM, 0.9994756860093246);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756598011288);
    AssertAlmostEqual(&test, rTM, 0.9994757122161583);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999258588578004);
    AssertAlmostEqual(&test, rTM, 0.999629225539411);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994743199373224);
    AssertAlmostEqual(&test, rTM, 0.9999478163095479);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.948909581600149);
    AssertAlmostEqual(&test, rTM, 0.9999947539584477);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03393165480795696);
    AssertAlmostEqual(&test, rTM, 0.999999852814651);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.63571062201726e-08);
    AssertAlmostEqual(&test, rTM, 0.9999998624753224);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998302058666691);
    AssertAlmostEqual(&test, rTM, 0.9983020586666926);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983020578184428);
    AssertAlmostEqual(&test, rTM, 0.9983020595149404);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982935973103946);
    AssertAlmostEqual(&test, rTM, 0.9983104781020411);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99759959331951);
    AssertAlmostEqual(&test, rTM, 0.9987990751167284);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9830666120897826);
    AssertAlmostEqual(&test, rTM, 0.999830913158299);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2139513475818033);
    AssertAlmostEqual(&test, rTM, 0.999997770002095);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462711464156703e-07);
    AssertAlmostEqual(&test, rTM, 0.9999985560469499);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348898797);
    AssertAlmostEqual(&test, rTM, 0.9934928348898796);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934928348574501);
    AssertAlmostEqual(&test, rTM, 0.9934928349223092);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934925106018196);
    AssertAlmostEqual(&test, rTM, 0.9934931591618322);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934604864665758);
    AssertAlmostEqual(&test, rTM, 0.9935250238178942);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9908099129278788);
    AssertAlmostEqual(&test, rTM, 0.995394325980086);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5263417692333279);
    AssertAlmostEqual(&test, rTM, 0.9999313317341533);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.346275730443331e-06);
    AssertAlmostEqual(&test, rTM, 0.9999786900858015);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252968663);
    AssertAlmostEqual(&test, rTM, 0.6758922252968662);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922252967356);
    AssertAlmostEqual(&test, rTM, 0.675892225296997);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758922239897303);
    AssertAlmostEqual(&test, rTM, 0.6758922266040024);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6758920945833015);
    AssertAlmostEqual(&test, rTM, 0.6758923560103886);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.675879154401105);
    AssertAlmostEqual(&test, rTM, 0.6759052957674518);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5766340948144548);
    AssertAlmostEqual(&test, rTM, 0.7554882735175927);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.434169976792413e-06);
    AssertAlmostEqual(&test, rTM, 0.9278933499352481);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776552e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776552e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776551e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166776486e-06);
    AssertAlmostEqual(&test, rTM, 6.549322166776616e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166770002e-06);
    AssertAlmostEqual(&test, rTM, 6.5493221667831e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549322166121627e-06);
    AssertAlmostEqual(&test, rTM, 6.549322167431474e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54931561754672e-06);
    AssertAlmostEqual(&test, rTM, 6.549328716006381e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274682530233813e-06);
    AssertAlmostEqual(&test, rTM, 9.823961803178829e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 0.05/CAPS_hbar_eV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044842494);
    AssertAlmostEqual(&test, rTM, 0.9999986022411478);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252208734666);
    AssertAlmostEqual(&test, rTM, 0.9999999980232691);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802647987);
    AssertAlmostEqual(&test, rTM, 0.9999999999801363);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057157211);
    AssertAlmostEqual(&test, rTM, 0.9999999999972207);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571619);
    AssertAlmostEqual(&test, rTM, 0.9999999999980362);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559202623337432e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933240239e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999980462);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374909826066);
    AssertAlmostEqual(&test, rTM, 0.9999374910451135);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116000885022);
    AssertAlmostEqual(&test, rTM, 0.9999557990673682);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937681029650367);
    AssertAlmostEqual(&test, rTM, 0.9999993749189964);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123133863407);
    AssertAlmostEqual(&test, rTM, 0.9999999374585671);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492416646361);
    AssertAlmostEqual(&test, rTM, 0.9999999934506836);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002557795071832058);
    AssertAlmostEqual(&test, rTM, 0.9999999980451914);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559104035839055e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999980461911);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738788373722);
    AssertAlmostEqual(&test, rTM, 0.9993738788374347);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738475419319);
    AssertAlmostEqual(&test, rTM, 0.9993739101313112);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991146458109309);
    AssertAlmostEqual(&test, rTM, 0.9995572248588559);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937253679817751);
    AssertAlmostEqual(&test, rTM, 0.9999376807418694);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392959963548961);
    AssertAlmostEqual(&test, rTM, 0.9999937340901996);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02427004064242905);
    AssertAlmostEqual(&test, rTM, 0.9999997941060814);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549242825829461e-08);
    AssertAlmostEqual(&test, rTM, 0.999999803863368);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870482205141);
    AssertAlmostEqual(&test, rTM, 0.997987048220516);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9979870472150535);
    AssertAlmostEqual(&test, rTM, 0.9979870492259761);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9979970281024165);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971544440365619);
    AssertAlmostEqual(&test, rTM, 0.9985762077049744);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9799536927423428);
    AssertAlmostEqual(&test, rTM, 0.9997995119397153);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1697682310293579);
    AssertAlmostEqual(&test, rTM, 0.9999971397021811);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462963343779866e-07);
    AssertAlmostEqual(&test, rTM, 0.9999979699292471);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992655355562703);
    AssertAlmostEqual(&test, rTM, 0.9926553555627029);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926553555261152);
    AssertAlmostEqual(&test, rTM, 0.9926553555992907);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992654989693261);
    AssertAlmostEqual(&test, rTM, 0.9926557214139874);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9926188593844166);
    AssertAlmostEqual(&test, rTM, 0.9926916719468587);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9896289500854523);
    AssertAlmostEqual(&test, rTM, 0.9948009248105844);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4860400540226439);
    AssertAlmostEqual(&test, rTM, 0.9999214418319045);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.840158956222254e-06);
    AssertAlmostEqual(&test, rTM, 0.999972829172563);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.674908956170422);
    AssertAlmostEqual(&test, rTM, 0.6749089561704219);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.674908956170291);
    AssertAlmostEqual(&test, rTM, 0.6749089561705529);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6749089548604591);
    AssertAlmostEqual(&test, rTM, 0.6749089574803847);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.67490882517418);
    AssertAlmostEqual(&test, rTM, 0.6749090871666212);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6748958570084914);
    AssertAlmostEqual(&test, rTM, 0.6749220549069971);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5754697389583573);
    AssertAlmostEqual(&test, rTM, 0.7546829817756417);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.386004206776965e-06);
    AssertAlmostEqual(&test, rTM, 0.9273889830563279);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54927188556687e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54927188556687e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566869e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271885566804e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885566934e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.54927188556032e-06);
    AssertAlmostEqual(&test, rTM, 6.549271885573417e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549271884911951e-06);
    AssertAlmostEqual(&test, rTM, 6.549271886221787e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549265336387318e-06);
    AssertAlmostEqual(&test, rTM, 6.549278434746419e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274657389299664e-06);
    AssertAlmostEqual(&test, rTM, 9.823886381693616e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 0.1/CAPS_hbar_eV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960465460392);
    AssertAlmostEqual(&test, rTM, 0.9999980232710658);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083837095408);
    AssertAlmostEqual(&test, rTM, 0.999999997204479);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478044703);
    AssertAlmostEqual(&test, rTM, 0.999999999971773);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829286505);
    AssertAlmostEqual(&test, rTM, 0.9999999999951954);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697694);
    AssertAlmostEqual(&test, rTM, 0.9999999999960825);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601664144626e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991620446e-13);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116009077859);
    AssertAlmostEqual(&test, rTM, 0.9999116009961809);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998749871562567);
    AssertAlmostEqual(&test, rTM, 0.9999374916244187);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911982553972627);
    AssertAlmostEqual(&test, rTM, 0.9999991160063995);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.915418227964539);
    AssertAlmostEqual(&test, rTM, 0.9999999115107753);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154340770521);
    AssertAlmostEqual(&test, rTM, 0.9999999903346132);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127924965835554);
    AssertAlmostEqual(&test, rTM, 0.9999999960914588);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279577016781733e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999960924587);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073553979);
    AssertAlmostEqual(&test, rTM, 0.9991155073554862);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514828);
    AssertAlmostEqual(&test, rTM, 0.9991155515571932);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987493677249552);
    AssertAlmostEqual(&test, rTM, 0.9993744881687859);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673537);
    AssertAlmostEqual(&test, rTM, 0.9999119537674048);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153360786259461);
    AssertAlmostEqual(&test, rTM, 0.9999911429854677);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245492450528109);
    AssertAlmostEqual(&test, rTM, 0.9999995986148017);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710685880781e-08);
    AssertAlmostEqual(&test, rTM, 0.9999996084902365);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850010229);
    AssertAlmostEqual(&test, rTM, 0.9971812850010255);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812835936562);
    AssertAlmostEqual(&test, rTM, 0.9971812864083915);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252196);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386693);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843617);
    AssertAlmostEqual(&test, rTM, 0.999719143004832);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013554757660668);
    AssertAlmostEqual(&test, rTM, 0.9999951175716814);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774879052e-07);
    AssertAlmostEqual(&test, rTM, 0.9999960162085332);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99038131886563);
    AssertAlmostEqual(&test, rTM, 0.99038131886563);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990381318817769);
    AssertAlmostEqual(&test, rTM, 0.9903813189134909);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.9903817974397553);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903335780866971);
    AssertAlmostEqual(&test, rTM, 0.9904288249949897);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.986424332453448);
    AssertAlmostEqual(&test, rTM, 0.993188891909765);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.3935965503084503);
    AssertAlmostEqual(&test, rTM, 0.9998926651956793);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.070460026519127e-06);
    AssertAlmostEqual(&test, rTM, 0.9999532932912735);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548482561);
    AssertAlmostEqual(&test, rTM, 0.671668854848256);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688548481241);
    AssertAlmostEqual(&test, rTM, 0.6716688548483879);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716688535290366);
    AssertAlmostEqual(&test, rTM, 0.6716688561674754);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716687229263597);
    AssertAlmostEqual(&test, rTM, 0.6716689867701097);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6716556631259593);
    AssertAlmostEqual(&test, rTM, 0.6716820461446487);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.571638658760516);
    AssertAlmostEqual(&test, rTM, 0.7520257533964058);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.230533016032387e-06);
    AssertAlmostEqual(&test, rTM, 0.925711712971059);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110366e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110366e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287110365e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287110299e-06);
    AssertAlmostEqual(&test, rTM, 6.54910428711043e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104287103816e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287116913e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549104286455463e-06);
    AssertAlmostEqual(&test, rTM, 6.549104287765266e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.549097738098408e-06);
    AssertAlmostEqual(&test, rTM, 6.549110836122321e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.274573588973776e-06);
    AssertAlmostEqual(&test, rTM, 9.823634985106507e-06);

    userdata[0] = 10/CAPS_hbar_eV; /* 10eV */
    userdata[1] = 1/CAPS_hbar_eV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874981344054);
    AssertAlmostEqual(&test, rTM, 0.9999937490476654);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987747123984);
    AssertAlmostEqual(&test, rTM, 0.9999999911597088);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861093208);
    AssertAlmostEqual(&test, rTM, 0.9999999999033472);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865837028941);
    AssertAlmostEqual(&test, rTM, 0.9999999999599378);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642580153);
    AssertAlmostEqual(&test, rTM, 0.9999999999609153);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601981373147e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609253);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27960201412074e-14);
    AssertAlmostEqual(&test, rTM, 0.9999999999609253);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204866988281);
    AssertAlmostEqual(&test, rTM, 0.9997204869783018);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996047315818192);
    AssertAlmostEqual(&test, rTM, 0.9998023462554779);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.972431434128665);
    AssertAlmostEqual(&test, rTM, 0.9999972043483077);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568047404149442);
    AssertAlmostEqual(&test, rTM, 0.9999997177303033);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656201194936);
    AssertAlmostEqual(&test, rTM, 0.9999999519549327);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279566770173473e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999609242759);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27959951659291e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999609252759);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128215705);
    AssertAlmostEqual(&test, rTM, 0.9972081128218492);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259838);
    AssertAlmostEqual(&test, rTM, 0.997208252210486);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960539608118743);
    AssertAlmostEqual(&test, rTM, 0.9980250282252416);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9722945898271455);
    AssertAlmostEqual(&test, rTM, 0.9997218200209527);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567741060847644);
    AssertAlmostEqual(&test, rTM, 0.9999717720678585);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276089001794276);
    AssertAlmostEqual(&test, rTM, 0.999996081799753);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279352062181047e-09);
    AssertAlmostEqual(&test, rTM, 0.9999960917869234);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902237023318);
    AssertAlmostEqual(&test, rTM, 0.9911902237023404);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902193169381);
    AssertAlmostEqual(&test, rTM, 0.9911902280877321);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673537);
    AssertAlmostEqual(&test, rTM, 0.9912337524565479);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.98756390651418);
    AssertAlmostEqual(&test, rTM, 0.99376243919542);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9149366326430387);
    AssertAlmostEqual(&test, rTM, 0.999119042917794);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01245491247828691);
    AssertAlmostEqual(&test, rTM, 0.9999598630564425);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277106858806546e-08);
    AssertAlmostEqual(&test, rTM, 0.9999608505410629);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686095647127);
    AssertAlmostEqual(&test, rTM, 0.9721686095647128);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721686094275197);
    AssertAlmostEqual(&test, rTM, 0.9721686097019059);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9721699813943628);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9720317673843617);
    AssertAlmostEqual(&test, rTM, 0.9723047916104839);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9608698610186749);
    AssertAlmostEqual(&test, rTM, 0.9802377476940242);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1013472891023817);
    AssertAlmostEqual(&test, rTM, 0.9995119794246027);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255080774754799e-07);
    AssertAlmostEqual(&test, rTM, 0.9996017779102482);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663489552);
    AssertAlmostEqual(&test, rTM, 0.6212976663489551);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976663488101);
    AssertAlmostEqual(&test, rTM, 0.6212976663491002);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212976648977296);
    AssertAlmostEqual(&test, rTM, 0.6212976678001808);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212975212264453);
    AssertAlmostEqual(&test, rTM, 0.6212978114714224);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6212831546445051);
    AssertAlmostEqual(&test, rTM, 0.6213121776272252);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5132335499853442);
    AssertAlmostEqual(&test, rTM, 0.7099692346882719);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.332110867149634e-06);
    AssertAlmostEqual(&test, rTM, 0.8965255993486199);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025427e-06);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025428e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025427e-06);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981025362e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981025492e-06);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088981018882e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981031973e-06);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546088980370827e-06);
    AssertAlmostEqual(&test, rTM, 6.546088981680027e-06);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -6.546082435028695e-06);
    AssertAlmostEqual(&test, rTM, 6.54609552702216e-06);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.273065916188251e-06);
    AssertAlmostEqual(&test, rTM, 9.819112045722351e-06);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 1e-05/CAPS_hbar_eV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999960461522);
    AssertAlmostEqual(&test, rTM, 0.999999998023076);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972042098354);
    AssertAlmostEqual(&test, rTM, 0.9999999999972041);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120395);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128217085);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724301645686362);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494263746385);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106307e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999033471858);
    AssertAlmostEqual(&test, rTM, 0.9999999033472823);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998633123504);
    AssertAlmostEqual(&test, rTM, 0.9999999316561727);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999999990335205);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518518243);
    AssertAlmostEqual(&test, rTM, 0.9999999999033472);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9999999999903346);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079053108835916);
    AssertAlmostEqual(&test, rTM, 0.9999999999999032);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001070233201797371);
    AssertAlmostEqual(&test, rTM, 0.9999999999999952);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999959937909639);
    AssertAlmostEqual(&test, rTM, 0.9999959937909643);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995993590659);
    AssertAlmostEqual(&test, rTM, 0.999995993991259);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999943343695487);
    AssertAlmostEqual(&test, rTM, 0.9999971671807618);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273334);
    AssertAlmostEqual(&test, rTM, 0.9999996013665826);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9999999599398323);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9999999995992979);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841845774);
    AssertAlmostEqual(&test, rTM, 0.9999999999919651);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262456815);
    AssertAlmostEqual(&test, rTM, 0.9999608262456814);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999608262260951);
    AssertAlmostEqual(&test, rTM, 0.9999608262652678);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999606308679948);
    AssertAlmostEqual(&test, rTM, 0.9999610206537838);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999446003948297);
    AssertAlmostEqual(&test, rTM, 0.9999722998137592);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996063784219265);
    AssertAlmostEqual(&test, rTM, 0.9999961019969298);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9615852669655288);
    AssertAlmostEqual(&test, rTM, 0.9999999608179846);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006507694559146438);
    AssertAlmostEqual(&test, rTM, 0.999999999231679);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298931513);
    AssertAlmostEqual(&test, rTM, 0.9996092298931512);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092298911977);
    AssertAlmostEqual(&test, rTM, 0.9996092298951046);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996092103589527);
    AssertAlmostEqual(&test, rTM, 0.9996092494263734);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996072812857492);
    AssertAlmostEqual(&test, rTM, 0.9996111688337552);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994474123472222);
    AssertAlmostEqual(&test, rTM, 0.9997236679886464);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9999960909921072);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483705);
    AssertAlmostEqual(&test, rTM, 0.9999999235195858);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118685054);
    AssertAlmostEqual(&test, rTM, 0.9616812118685053);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616812118684867);
    AssertAlmostEqual(&test, rTM, 0.9616812118685242);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.961681211680654);
    AssertAlmostEqual(&test, rTM, 0.9616812120563567);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616811930833691);
    AssertAlmostEqual(&test, rTM, 0.9616812306536326);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616793334031958);
    AssertAlmostEqual(&test, rTM, 0.9616830902435319);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462457064406125);
    AssertAlmostEqual(&test, rTM, 0.9727464893294936);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540920081542527);
    AssertAlmostEqual(&test, rTM, 0.9992361661461726);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838972);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838972);
    AssertAlmostEqual(&test, rTM, 0.0006540960015838971);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015838907);
    AssertAlmostEqual(&test, rTM, 0.0006540960015839036);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654096001583244);
    AssertAlmostEqual(&test, rTM, 0.0006540960015845504);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540960015185732);
    AssertAlmostEqual(&test, rTM, 0.0006540960016492212);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540953483436719);
    AssertAlmostEqual(&test, rTM, 0.0006540966548241225);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272619565398874);
    AssertAlmostEqual(&test, rTM, 0.0009809299068861922);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 0.001/CAPS_hbar_eV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604653449);
    AssertAlmostEqual(&test, rTM, 0.9999999802326721);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451534244);
    AssertAlmostEqual(&test, rTM, 0.9999999999720447);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083824072685);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327931897561);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048451796883);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205310115);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991151158812);
    AssertAlmostEqual(&test, rTM, 0.9999991151167661);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987485857332);
    AssertAlmostEqual(&test, rTM, 0.9999993742926707);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843089);
    AssertAlmostEqual(&test, rTM, 0.9999999911516017);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133916);
    AssertAlmostEqual(&test, rTM, 0.9999999991151163);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911902236584822);
    AssertAlmostEqual(&test, rTM, 0.9999999999115107);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840386574584);
    AssertAlmostEqual(&test, rTM, 0.9999999999990323);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629434253e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996084);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347696463);
    AssertAlmostEqual(&test, rTM, 0.999990334769647);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903342863996);
    AssertAlmostEqual(&test, rTM, 0.9999903352528695);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999863313275121);
    AssertAlmostEqual(&test, rTM, 0.9999931656404016);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999990382694482);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.999999903352055);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.907905310445389);
    AssertAlmostEqual(&test, rTM, 0.9999999990323443);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320179736);
    AssertAlmostEqual(&test, rTM, 0.9999999999532811);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999951956162726);
    AssertAlmostEqual(&test, rTM, 0.999951956162726);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999519561387047);
    AssertAlmostEqual(&test, rTM, 0.9999519561867473);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999521945894526);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999320564298108);
    AssertAlmostEqual(&test, rTM, 0.9999660276378348);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995172703681532);
    AssertAlmostEqual(&test, rTM, 0.999995219355964);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9999999519411729);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328403284714138);
    AssertAlmostEqual(&test, rTM, 0.9999999988448398);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585347586);
    AssertAlmostEqual(&test, rTM, 0.9995994585347585);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994585327563);
    AssertAlmostEqual(&test, rTM, 0.9995994585367608);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995994385121977);
    AssertAlmostEqual(&test, rTM, 0.9995994785563187);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999597461211484);
    AssertAlmostEqual(&test, rTM, 0.9996014459496585);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994335958248992);
    AssertAlmostEqual(&test, rTM, 0.9997167577936957);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9999959931877275);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222864841224324);
    AssertAlmostEqual(&test, rTM, 0.9999999196511929);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184992);
    AssertAlmostEqual(&test, rTM, 0.9616716943184991);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716943184804);
    AssertAlmostEqual(&test, rTM, 0.961671694318518);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716941306022);
    AssertAlmostEqual(&test, rTM, 0.9616716945063962);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616716755287918);
    AssertAlmostEqual(&test, rTM, 0.9616717131081974);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616698153960996);
    AssertAlmostEqual(&test, rTM, 0.9616735731505945);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462324651839);
    AssertAlmostEqual(&test, rTM, 0.9727396793627803);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067434);
    AssertAlmostEqual(&test, rTM, 0.9992357798975066);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722819);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654095670572282);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722819);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705722755);
    AssertAlmostEqual(&test, rTM, 0.0006540956705722884);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705716288);
    AssertAlmostEqual(&test, rTM, 0.0006540956705729351);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540956705069579);
    AssertAlmostEqual(&test, rTM, 0.0006540956706376059);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950173323868);
    AssertAlmostEqual(&test, rTM, 0.0006540963238121771);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272617908175134);
    AssertAlmostEqual(&test, rTM, 0.0009809294105855477);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 0.003/CAPS_hbar_eV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999315240141);
    AssertAlmostEqual(&test, rTM, 0.9999999657620064);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999515813123835);
    AssertAlmostEqual(&test, rTM, 0.9999999999515802);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9951697246488874);
    AssertAlmostEqual(&test, rTM, 0.9999999999995157);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167662036);
    AssertAlmostEqual(&test, rTM, 0.9999999999999515);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.6190377937840901);
    AssertAlmostEqual(&test, rTM, 0.999999999999995);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004261702532566128);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265337273987986e-10);
    AssertAlmostEqual(&test, rTM, 0.9999999999999988);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984683327592);
    AssertAlmostEqual(&test, rTM, 0.9999984683342907);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999978338971851);
    AssertAlmostEqual(&test, rTM, 0.9999989169480059);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468373077972);
    AssertAlmostEqual(&test, rTM, 0.9999999846840893);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984695041409809);
    AssertAlmostEqual(&test, rTM, 0.9999999984683327);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.984800174576859);
    AssertAlmostEqual(&test, rTM, 0.9999999998468286);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.243769477223779);
    AssertAlmostEqual(&test, rTM, 0.9999999999980708);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.262560451572352e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999988269);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841977143524);
    AssertAlmostEqual(&test, rTM, 0.9999841977143539);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841969242649);
    AssertAlmostEqual(&test, rTM, 0.9999841985044019);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999776522664613);
    AssertAlmostEqual(&test, rTM, 0.9999888260708019);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998412003500827);
    AssertAlmostEqual(&test, rTM, 0.9999984276026166);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.998420928151886);
    AssertAlmostEqual(&test, rTM, 0.9999998419837587);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8539692059339854);
    AssertAlmostEqual(&test, rTM, 0.9999999984148339);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.004225621647319e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999998751319);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377821062179);
    AssertAlmostEqual(&test, rTM, 0.9999377821062178);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999377820751099);
    AssertAlmostEqual(&test, rTM, 0.9999377821373256);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374718003101);
    AssertAlmostEqual(&test, rTM, 0.9999380908722318);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999912011744628);
    AssertAlmostEqual(&test, rTM, 0.9999560049045084);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999374893923756);
    AssertAlmostEqual(&test, rTM, 0.9999938089144454);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9396856932331351);
    AssertAlmostEqual(&test, rTM, 0.9999999377501019);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002581773204230588);
    AssertAlmostEqual(&test, rTM, 0.9999999980633466);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124523578);
    AssertAlmostEqual(&test, rTM, 0.9995804124523577);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995804124502603);
    AssertAlmostEqual(&test, rTM, 0.9995804124544552);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995803914779072);
    AssertAlmostEqual(&test, rTM, 0.9995804334257601);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999578320174724);
    AssertAlmostEqual(&test, rTM, 0.9995824943507621);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994066651730378);
    AssertAlmostEqual(&test, rTM, 0.9997032885611503);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9589018276463681);
    AssertAlmostEqual(&test, rTM, 0.9999958025388939);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0005671263367985099);
    AssertAlmostEqual(&test, rTM, 0.9999999118362589);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845471);
    AssertAlmostEqual(&test, rTM, 0.9616524745845469);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524745845283);
    AssertAlmostEqual(&test, rTM, 0.9616524745845657);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524743965577);
    AssertAlmostEqual(&test, rTM, 0.9616524747725363);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616524557856091);
    AssertAlmostEqual(&test, rTM, 0.9616524933834759);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9616505947391151);
    AssertAlmostEqual(&test, rTM, 0.9616543543396323);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9462057259684601);
    AssertAlmostEqual(&test, rTM, 0.9727259272565365);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006530938225297406);
    AssertAlmostEqual(&test, rTM, 0.9992349995980829);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629703);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629703);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629702);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018629637);
    AssertAlmostEqual(&test, rTM, 0.0006540950018629767);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950018623171);
    AssertAlmostEqual(&test, rTM, 0.0006540950018636235);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540950017976463);
    AssertAlmostEqual(&test, rTM, 0.0006540950019282942);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654094348623742);
    AssertAlmostEqual(&test, rTM, 0.0006540956551021984);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272614560253507);
    AssertAlmostEqual(&test, rTM, 0.0009809284079595154);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 0.035/CAPS_hbar_eV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997661100704);
    AssertAlmostEqual(&test, rTM, 0.9999998830550283);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998346284181754);
    AssertAlmostEqual(&test, rTM, 0.9999999998346148);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835976783608862);
    AssertAlmostEqual(&test, rTM, 0.999999999998346);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264594605265);
    AssertAlmostEqual(&test, rTM, 0.999999999999834);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.2215488748061893);
    AssertAlmostEqual(&test, rTM, 0.9999999999999785);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655738254590529e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999862);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005557424687e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999862);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947699268069);
    AssertAlmostEqual(&test, rTM, 0.9999947699320368);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999992603571268);
    AssertAlmostEqual(&test, rTM, 0.9999963017787955);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771021894279);
    AssertAlmostEqual(&test, rTM, 0.9999999477017718);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947835721514474);
    AssertAlmostEqual(&test, rTM, 0.9999999947699004);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9490489665009748);
    AssertAlmostEqual(&test, rTM, 0.9999999994768127);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03410679061865234);
    AssertAlmostEqual(&test, rTM, 0.9999999999853572);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655801424234677e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999863231);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999475562254906);
    AssertAlmostEqual(&test, rTM, 0.9999475562254957);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999475536034388);
    AssertAlmostEqual(&test, rTM, 0.9999475588474164);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999258341084059);
    AssertAlmostEqual(&test, rTM, 0.9999629163665922);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994730716498563);
    AssertAlmostEqual(&test, rTM, 0.9999947815259953);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947689586172078);
    AssertAlmostEqual(&test, rTM, 0.9999994755730579);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5953416785755776);
    AssertAlmostEqual(&test, rTM, 0.9999999945781699);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.635684449838099e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999986247431);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300759715294);
    AssertAlmostEqual(&test, rTM, 0.9998300759715294);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998300758865747);
    AssertAlmostEqual(&test, rTM, 0.9998300760564841);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998292285372542);
    AssertAlmostEqual(&test, rTM, 0.9998309192008623);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997596995919837);
    AssertAlmostEqual(&test, rTM, 0.999879842576655);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9982935973103946);
    AssertAlmostEqual(&test, rTM, 0.9999830906274106);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8438886474015775);
    AssertAlmostEqual(&test, rTM, 0.9999998294492779);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.462474075243879e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999855594588);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690081198);
    AssertAlmostEqual(&test, rTM, 0.9993473690081197);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473690048578);
    AssertAlmostEqual(&test, rTM, 0.9993473690113818);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993473363880379);
    AssertAlmostEqual(&test, rTM, 0.9993474016265718);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999344115038326);
    AssertAlmostEqual(&test, rTM, 0.9993506068395952);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990771651835323);
    AssertAlmostEqual(&test, rTM, 0.9995384760650238);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9368087931574401);
    AssertAlmostEqual(&test, rTM, 0.9999934684305081);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0002345186373606611);
    AssertAlmostEqual(&test, rTM, 0.9999997867973857);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138438);
    AssertAlmostEqual(&test, rTM, 0.9613463365138437);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463365138248);
    AssertAlmostEqual(&test, rTM, 0.9613463365138626);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463363243844);
    AssertAlmostEqual(&test, rTM, 0.9613463367033032);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613463175679048);
    AssertAlmostEqual(&test, rTM, 0.9613463554597736);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9613444419686951);
    AssertAlmostEqual(&test, rTM, 0.9613482309679687);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.94577984572264);
    AssertAlmostEqual(&test, rTM, 0.9725068677392248);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006425986147753021);
    AssertAlmostEqual(&test, rTM, 0.999222514973224);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999324);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999324);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999323);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026999259);
    AssertAlmostEqual(&test, rTM, 0.0006540843026999388);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026992791);
    AssertAlmostEqual(&test, rTM, 0.0006540843027005855);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540843026346094);
    AssertAlmostEqual(&test, rTM, 0.0006540843027652551);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540836494713753);
    AssertAlmostEqual(&test, rTM, 0.0006540849559284893);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272560994439048);
    AssertAlmostEqual(&test, rTM, 0.0009809123662217396);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 0.05/CAPS_hbar_eV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204480733);
    AssertAlmostEqual(&test, rTM, 0.9999998602240268);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999802346346827);
    AssertAlmostEqual(&test, rTM, 0.9999999998023269);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270987041049);
    AssertAlmostEqual(&test, rTM, 0.9999999999980231);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8209010802727921);
    AssertAlmostEqual(&test, rTM, 0.9999999999998013);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1744276057158425);
    AssertAlmostEqual(&test, rTM, 0.9999999999999721);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559072951126295e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203933110558e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999805);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937489224208);
    AssertAlmostEqual(&test, rTM, 0.9999937489286717);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911596571732);
    AssertAlmostEqual(&test, rTM, 0.9999955798188175);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750547160096);
    AssertAlmostEqual(&test, rTM, 0.9999999374921842);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684104566402);
    AssertAlmostEqual(&test, rTM, 0.9999999937488786);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9394123424403014);
    AssertAlmostEqual(&test, rTM, 0.9999999993745853);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02435945792240269);
    AssertAlmostEqual(&test, rTM, 0.9999999999794862);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559103906168597e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999804619);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373702344783);
    AssertAlmostEqual(&test, rTM, 0.9999373702344844);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999373671031694);
    AssertAlmostEqual(&test, rTM, 0.9999373733656366);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999114292850938);
    AssertAlmostEqual(&test, rTM, 0.9999557136618852);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993707570020295);
    AssertAlmostEqual(&test, rTM, 0.9999937679293661);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937560990756683);
    AssertAlmostEqual(&test, rTM, 0.9999993737111704);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.539826586949107);
    AssertAlmostEqual(&test, rTM, 0.9999999934368993);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.549229958605782e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999980386234);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985222166441);
    AssertAlmostEqual(&test, rTM, 0.9997985222166442);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997985221159155);
    AssertAlmostEqual(&test, rTM, 0.9997985223173728);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997975174354314);
    AssertAlmostEqual(&test, rTM, 0.9997995220123211);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997150792767125);
    AssertAlmostEqual(&test, rTM, 0.99985752948871);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997977018663828);
    AssertAlmostEqual(&test, rTM, 0.9999799503822804);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8177825156638335);
    AssertAlmostEqual(&test, rTM, 0.9999997974819816);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.462843240599714e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999796982616);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950818061);
    AssertAlmostEqual(&test, rTM, 0.999263095081806);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630950781229);
    AssertAlmostEqual(&test, rTM, 0.9992630950854892);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992630582510623);
    AssertAlmostEqual(&test, rTM, 0.9992631319107097);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9992594210842055);
    AssertAlmostEqual(&test, rTM, 0.9992667508594608);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9989580181664545);
    AssertAlmostEqual(&test, rTM, 0.9994788732613165);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.928946008285672);
    AssertAlmostEqual(&test, rTM, 0.999992623624848);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001839488798028095);
    AssertAlmostEqual(&test, rTM, 0.9999997281854351);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987618);
    AssertAlmostEqual(&test, rTM, 0.9612037159987616);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037159987428);
    AssertAlmostEqual(&test, rTM, 0.9612037159987807);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612037158086177);
    AssertAlmostEqual(&test, rTM, 0.9612037161889058);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612036969843564);
    AssertAlmostEqual(&test, rTM, 0.961203735013158);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9612018146071539);
    AssertAlmostEqual(&test, rTM, 0.9612056172990309);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9455814605533744);
    AssertAlmostEqual(&test, rTM, 0.9724048070640724);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006377942350022938);
    AssertAlmostEqual(&test, rTM, 0.9992166629128281);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877466);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877466);
    AssertAlmostEqual(&test, rTM, 0.0006540792875877465);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875877401);
    AssertAlmostEqual(&test, rTM, 0.000654079287587753);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875870934);
    AssertAlmostEqual(&test, rTM, 0.0006540792875883997);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540792875224242);
    AssertAlmostEqual(&test, rTM, 0.0006540792876530689);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540786343641915);
    AssertAlmostEqual(&test, rTM, 0.0006540799408113016);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272535886067145);
    AssertAlmostEqual(&test, rTM, 0.0009809048468377712);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 0.1/CAPS_hbar_eV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999996046539006);
    AssertAlmostEqual(&test, rTM, 0.9999998023269306);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204869691065);
    AssertAlmostEqual(&test, rTM, 0.9999999997204482);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328194759417);
    AssertAlmostEqual(&test, rTM, 0.9999999999972041);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.756805047814842);
    AssertAlmostEqual(&test, rTM, 0.9999999999997177);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029657829287334);
    AssertAlmostEqual(&test, rTM, 0.9999999999999519);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279569245043194e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601991588025e-11);
    AssertAlmostEqual(&test, rTM, 0.9999999999999609);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911597391081);
    AssertAlmostEqual(&test, rTM, 0.9999911597479483);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999874980122925);
    AssertAlmostEqual(&test, rTM, 0.9999937489866085);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999116316951742);
    AssertAlmostEqual(&test, rTM, 0.9999999116014595);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986891252024);
    AssertAlmostEqual(&test, rTM, 0.9999999911596225);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154182679836648);
    AssertAlmostEqual(&test, rTM, 0.9999999991151072);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247842060859247);
    AssertAlmostEqual(&test, rTM, 0.999999999959937);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27957698436285e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999609245);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115155082227);
    AssertAlmostEqual(&test, rTM, 0.9999115155082314);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115110843089);
    AssertAlmostEqual(&test, rTM, 0.9999115199319241);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249645);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911897851734701);
    AssertAlmostEqual(&test, rTM, 0.9999991151519048);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238840369425579);
    AssertAlmostEqual(&test, rTM, 0.9999999903237413);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27710362943424e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999960848909);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358474);
    AssertAlmostEqual(&test, rTM, 0.9997177702358476);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177700947526);
    AssertAlmostEqual(&test, rTM, 0.9997177703769423);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970266);
    AssertAlmostEqual(&test, rTM, 0.9997191706917838);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691821);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252196);
    AssertAlmostEqual(&test, rTM, 0.9999719134918307);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547709516640665);
    AssertAlmostEqual(&test, rTM, 0.9999997149331797);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586342301e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999601609382);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999033939268838);
    AssertAlmostEqual(&test, rTM, 0.9990339392688379);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99903393926401);
    AssertAlmostEqual(&test, rTM, 0.9990339392736658);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990338909903526);
    AssertAlmostEqual(&test, rTM, 0.9990339875449118);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9990291233210521);
    AssertAlmostEqual(&test, rTM, 0.9990387313390288);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9986340572660607);
    AssertAlmostEqual(&test, rTM, 0.9993167951689123);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9079009285403404);
    AssertAlmostEqual(&test, rTM, 0.9999903239749219);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000107023320169037);
    AssertAlmostEqual(&test, rTM, 0.9999995328123255);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946349);
    AssertAlmostEqual(&test, rTM, 0.9607322815946348);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322815946157);
    AssertAlmostEqual(&test, rTM, 0.960732281594654);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322814022283);
    AssertAlmostEqual(&test, rTM, 0.9607322817870413);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607322623539893);
    AssertAlmostEqual(&test, rTM, 0.9607323008352711);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9607303575796227);
    AssertAlmostEqual(&test, rTM, 0.9607342055172676);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9449257839727583);
    AssertAlmostEqual(&test, rTM, 0.9720674101900894);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006222858626727194);
    AssertAlmostEqual(&test, rTM, 0.9991971565403952);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025422);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025423);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025422);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625711025358);
    AssertAlmostEqual(&test, rTM, 0.0006540625711025487);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000654062571101889);
    AssertAlmostEqual(&test, rTM, 0.0006540625711031954);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006540625710372215);
    AssertAlmostEqual(&test, rTM, 0.000654062571167863);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.00065406191789566);
    AssertAlmostEqual(&test, rTM, 0.0006540632243094245);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003272452194276659);
    AssertAlmostEqual(&test, rTM, 0.0009808797830571196);

    userdata[0] = 100/CAPS_hbar_eV; /* 100eV */
    userdata[1] = 1/CAPS_hbar_eV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987498064071);
    AssertAlmostEqual(&test, rTM, 0.9999993749030082);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163692985978);
    AssertAlmostEqual(&test, rTM, 0.9999999991159794);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190580581683);
    AssertAlmostEqual(&test, rTM, 0.9999999999911511);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861262995);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01247865837030146);
    AssertAlmostEqual(&test, rTM, 0.9999999999995993);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279598739368619e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602014117498e-12);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720451534244);
    AssertAlmostEqual(&test, rTM, 0.9999720451813787);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604661254961);
    AssertAlmostEqual(&test, rTM, 0.9999802328673763);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.997208243025123);
    AssertAlmostEqual(&test, rTM, 0.9999997204615091);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327795988127);
    AssertAlmostEqual(&test, rTM, 0.9999999720420603);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568048441320415);
    AssertAlmostEqual(&test, rTM, 0.9999999971773011);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276335205308842);
    AssertAlmostEqual(&test, rTM, 0.9999999996082539);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599513350907e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999996092527);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120395);
    AssertAlmostEqual(&test, rTM, 0.9997204598120674);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204458373474);
    AssertAlmostEqual(&test, rTM, 0.999720473786061);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996046933649861);
    AssertAlmostEqual(&test, rTM, 0.999802327143283);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971942076732974);
    AssertAlmostEqual(&test, rTM, 0.9999721811831622);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724288053798037);
    AssertAlmostEqual(&test, rTM, 0.9999972040779022);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029494255373305);
    AssertAlmostEqual(&test, rTM, 0.999999951947213);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279351738106294e-07);
    AssertAlmostEqual(&test, rTM, 0.999999960917708);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073554416);
    AssertAlmostEqual(&test, rTM, 0.9991155073554424);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155069133916);
    AssertAlmostEqual(&test, rTM, 0.9991155077974924);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9991198949916958);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9987493677249552);
    AssertAlmostEqual(&test, rTM, 0.9993744881687859);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911464797673537);
    AssertAlmostEqual(&test, rTM, 0.9999119537674048);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4238838671505174);
    AssertAlmostEqual(&test, rTM, 0.9999990323751941);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.277103629432975e-06);
    AssertAlmostEqual(&test, rTM, 0.9999996084892464);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812850010242);
    AssertAlmostEqual(&test, rTM, 0.9971812850010242);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971812849869506);
    AssertAlmostEqual(&test, rTM, 0.9971812850150978);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971811442677116);
    AssertAlmostEqual(&test, rTM, 0.9971814257273205);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9971672464252196);
    AssertAlmostEqual(&test, rTM, 0.9971952541020823);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960160647039784);
    AssertAlmostEqual(&test, rTM, 0.9980060424386693);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7547605095735995);
    AssertAlmostEqual(&test, rTM, 0.999971495159818);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.255049586218054e-05);
    AssertAlmostEqual(&test, rTM, 0.999996016109535);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699752);
    AssertAlmostEqual(&test, rTM, 0.9530953082699751);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530953082699524);
    AssertAlmostEqual(&test, rTM, 0.953095308269998);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953095308041084);
    AssertAlmostEqual(&test, rTM, 0.9530953084988664);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9530952853808567);
    AssertAlmostEqual(&test, rTM, 0.9530953311590827);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.953093019417529);
    AssertAlmostEqual(&test, rTM, 0.9530975970134177);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9343232438085882);
    AssertAlmostEqual(&test, rTM, 0.9665945077003362);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0004328398960064893);
    AssertAlmostEqual(&test, rTM, 0.9988461721128812);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136614);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136614);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136613);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204136549);
    AssertAlmostEqual(&test, rTM, 0.0006537618204136678);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618204130085);
    AssertAlmostEqual(&test, rTM, 0.0006537618204143142);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537618203483706);
    AssertAlmostEqual(&test, rTM, 0.000653761820478952);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0006537611675067436);
    AssertAlmostEqual(&test, rTM, 0.000653762473320579);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0003270946473704986);
    AssertAlmostEqual(&test, rTM, 0.0009804288539290908);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 1e-05/CAPS_hbar_eV; /* 1e-05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999996046153);
    AssertAlmostEqual(&test, rTM, 0.9999999998023076);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997204206319);
    AssertAlmostEqual(&test, rTM, 0.9999999999997203);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424640689);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204598120534);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972081128217098);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845829364064);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279319331667343e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999903347182);
    AssertAlmostEqual(&test, rTM, 0.9999999903347278);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999863312342);
    AssertAlmostEqual(&test, rTM, 0.9999999931656171);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244359);
    AssertAlmostEqual(&test, rTM, 0.999999999903352);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999903347648141);
    AssertAlmostEqual(&test, rTM, 0.9999999999903346);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996628);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903813188656252);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973247);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993783742);
    AssertAlmostEqual(&test, rTM, 0.9999995993783741);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999995993583436);
    AssertAlmostEqual(&test, rTM, 0.9999995993984037);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994334355105);
    AssertAlmostEqual(&test, rTM, 0.999999716717715);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999995973809788);
    AssertAlmostEqual(&test, rTM, 0.999999960136651);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288946);
    AssertAlmostEqual(&test, rTM, 0.9999999959939831);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9999999999599377);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736897713);
    AssertAlmostEqual(&test, rTM, 0.9999999999999103);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99999608255551);
    AssertAlmostEqual(&test, rTM, 0.9999960825555099);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960825535513);
    AssertAlmostEqual(&test, rTM, 0.9999960825574686);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999960630170508);
    AssertAlmostEqual(&test, rTM, 0.9999961019970038);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999944599013673);
    AssertAlmostEqual(&test, rTM, 0.9999972299468469);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999606308679948);
    AssertAlmostEqual(&test, rTM, 0.9999996101990165);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960902115865451);
    AssertAlmostEqual(&test, rTM, 0.9999999960825422);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05784161748319046);
    AssertAlmostEqual(&test, rTM, 0.9999999999913846);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161158104);
    AssertAlmostEqual(&test, rTM, 0.9999609161158103);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609161156149);
    AssertAlmostEqual(&test, rTM, 0.9999609161160057);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999609141617032);
    AssertAlmostEqual(&test, rTM, 0.9999609180698197);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999607211863388);
    AssertAlmostEqual(&test, rTM, 0.9999611100779215);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999447274883247);
    AssertAlmostEqual(&test, rTM, 0.9999723633622651);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.9999996091723911);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433577);
    AssertAlmostEqual(&test, rTM, 0.999999999142003);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959419);
    AssertAlmostEqual(&test, rTM, 0.9961001517959418);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517959399);
    AssertAlmostEqual(&test, rTM, 0.9961001517959437);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9961001517764808);
    AssertAlmostEqual(&test, rTM, 0.9961001518154029);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996100149849828);
    AssertAlmostEqual(&test, rTM, 0.9961001537420549);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996099957189379);
    AssertAlmostEqual(&test, rTM, 0.9961003463928131);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944892432312222);
    AssertAlmostEqual(&test, rTM, 0.9972408098061243);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810483841676955);
    AssertAlmostEqual(&test, rTM, 0.9999914239951387);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629603);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629602);
    AssertAlmostEqual(&test, rTM, 0.05810515461629602);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461629551);
    AssertAlmostEqual(&test, rTM, 0.05810515461629653);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581051546162443);
    AssertAlmostEqual(&test, rTM, 0.05810515461634774);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810515461112367);
    AssertAlmostEqual(&test, rTM, 0.05810515462146837);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810510289280096);
    AssertAlmostEqual(&test, rTM, 0.05810520633979076);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076373994129392);
    AssertAlmostEqual(&test, rTM, 0.08535967865244831);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 0.001/CAPS_hbar_eV; /* 0.001eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999960465344);
    AssertAlmostEqual(&test, rTM, 0.9999999980232671);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044801755);
    AssertAlmostEqual(&test, rTM, 0.9999999999972045);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204868385511);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083824074065);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724327931897695);
    AssertAlmostEqual(&test, rTM, 0.9999999999999997);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209569059);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999911511553);
    AssertAlmostEqual(&test, rTM, 0.9999999115116414);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998748585029);
    AssertAlmostEqual(&test, rTM, 0.9999999374292494);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560454);
    AssertAlmostEqual(&test, rTM, 0.9999999991151601);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639868);
    AssertAlmostEqual(&test, rTM, 0.9999999999115116);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991155073510216);
    AssertAlmostEqual(&test, rTM, 0.9999999999911511);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401244070082);
    AssertAlmostEqual(&test, rTM, 0.9999999999999114);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795136403);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334727609);
    AssertAlmostEqual(&test, rTM, 0.9999990334727609);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999990334244359);
    AssertAlmostEqual(&test, rTM, 0.9999990335210835);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999986331243437);
    AssertAlmostEqual(&test, rTM, 0.9999993165619382);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999902865639442);
    AssertAlmostEqual(&test, rTM, 0.9999999038269033);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680954);
    AssertAlmostEqual(&test, rTM, 0.9999999903352061);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.990381318817769);
    AssertAlmostEqual(&test, rTM, 0.9999999999033461);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030973236);
    AssertAlmostEqual(&test, rTM, 0.9999999999995229);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955123996);
    AssertAlmostEqual(&test, rTM, 0.9999951955123995);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951955099974);
    AssertAlmostEqual(&test, rTM, 0.9999951955148016);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951715497771);
    AssertAlmostEqual(&test, rTM, 0.9999952193561006);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999932054352361);
    AssertAlmostEqual(&test, rTM, 0.9999966027118472);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999517165468885);
    AssertAlmostEqual(&test, rTM, 0.9999995219345814);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103135);
    AssertAlmostEqual(&test, rTM, 0.9999999951954893);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993086986309919);
    AssertAlmostEqual(&test, rTM, 0.9999999999874982);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386318728);
    AssertAlmostEqual(&test, rTM, 0.9999599386318727);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599386316725);
    AssertAlmostEqual(&test, rTM, 0.999959938632073);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999599366288946);
    AssertAlmostEqual(&test, rTM, 0.9999599406347508);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999597388273334);
    AssertAlmostEqual(&test, rTM, 0.9999601374448599);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999433451399429);
    AssertAlmostEqual(&test, rTM, 0.9999716721687327);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848566);
    AssertAlmostEqual(&test, rTM, 0.9999995993976001);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557345736400544);
    AssertAlmostEqual(&test, rTM, 0.9999999991030686);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865778);
    AssertAlmostEqual(&test, rTM, 0.9960991657865776);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657865759);
    AssertAlmostEqual(&test, rTM, 0.9960991657865796);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991657671118);
    AssertAlmostEqual(&test, rTM, 0.9960991658060437);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960991638399728);
    AssertAlmostEqual(&test, rTM, 0.9960991677331817);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960989711309085);
    AssertAlmostEqual(&test, rTM, 0.9960993604325529);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944878510614401);
    AssertAlmostEqual(&test, rTM, 0.9972401117910541);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.999991420100616);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683113);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683113);
    AssertAlmostEqual(&test, rTM, 0.05810512840683112);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840683061);
    AssertAlmostEqual(&test, rTM, 0.05810512840683164);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840677941);
    AssertAlmostEqual(&test, rTM, 0.05810512840688285);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810512840165877);
    AssertAlmostEqual(&test, rTM, 0.05810512841200347);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507668335668);
    AssertAlmostEqual(&test, rTM, 0.05810518013030526);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.030763725283131);
    AssertAlmostEqual(&test, rTM, 0.08535964100431835);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 0.003/CAPS_hbar_eV; /* 0.003eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999931524013);
    AssertAlmostEqual(&test, rTM, 0.9999999965762005);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999951580257381);
    AssertAlmostEqual(&test, rTM, 0.999999999995158);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9995159188534715);
    AssertAlmostEqual(&test, rTM, 0.9999999999999515);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995169724649126);
    AssertAlmostEqual(&test, rTM, 0.9999999999999951);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9527382167662265);
    AssertAlmostEqual(&test, rTM, 0.9999999999999994);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03936164359493153);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.265336913764604e-08);
    AssertAlmostEqual(&test, rTM, 0.9999999999999999);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998468331704);
    AssertAlmostEqual(&test, rTM, 0.9999998468333234);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999997833895075);
    AssertAlmostEqual(&test, rTM, 0.9999998916947478);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999846826750161);
    AssertAlmostEqual(&test, rTM, 0.9999999984684089);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998468448881994);
    AssertAlmostEqual(&test, rTM, 0.9999999998468333);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9984695048979956);
    AssertAlmostEqual(&test, rTM, 0.9999999999846833);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.858114758129039);
    AssertAlmostEqual(&test, rTM, 0.9999999999998463);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -4.26220073512695e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999999999882);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984197601981);
    AssertAlmostEqual(&test, rTM, 0.9999984197601982);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999984196811882);
    AssertAlmostEqual(&test, rTM, 0.9999984198392041);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999977652041718);
    AssertAlmostEqual(&test, rTM, 0.9999988826014615);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999841189000979);
    AssertAlmostEqual(&test, rTM, 0.9999998427601509);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999841980480512);
    AssertAlmostEqual(&test, rTM, 0.9999999841983795);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9843219542496597);
    AssertAlmostEqual(&test, rTM, 0.9999999998419709);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003972791069700549);
    AssertAlmostEqual(&test, rTM, 0.9999999999987415);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993778036416);
    AssertAlmostEqual(&test, rTM, 0.9999937780364159);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999993778033305);
    AssertAlmostEqual(&test, rTM, 0.9999937780395268);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937470040832);
    AssertAlmostEqual(&test, rTM, 0.9999938089147421);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999912008260536);
    AssertAlmostEqual(&test, rTM, 0.9999956004033485);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374718003101);
    AssertAlmostEqual(&test, rTM, 0.999999380889749);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937973403946726);
    AssertAlmostEqual(&test, rTM, 0.99999999377799);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.02457697209920648);
    AssertAlmostEqual(&test, rTM, 0.9999999999796679);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999958033320408);
    AssertAlmostEqual(&test, rTM, 0.9999580333204079);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580333201982);
    AssertAlmostEqual(&test, rTM, 0.9999580333206177);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999580312221705);
    AssertAlmostEqual(&test, rTM, 0.9999580354185406);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999578240134009);
    AssertAlmostEqual(&test, rTM, 0.9999582415887076);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999940650668406);
    AssertAlmostEqual(&test, rTM, 0.9999703248938905);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9958118321656215);
    AssertAlmostEqual(&test, rTM, 0.9999995803445442);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05112045649339815);
    AssertAlmostEqual(&test, rTM, 0.9999999990244739);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128816);
    AssertAlmostEqual(&test, rTM, 0.9960971746128815);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971746128796);
    AssertAlmostEqual(&test, rTM, 0.9960971746128834);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971745934056);
    AssertAlmostEqual(&test, rTM, 0.9960971746323575);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960971726652849);
    AssertAlmostEqual(&test, rTM, 0.9960971765604772);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960969798580458);
    AssertAlmostEqual(&test, rTM, 0.9960973693580184);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944850396782712);
    AssertAlmostEqual(&test, rTM, 0.997238702200121);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05802578934151381);
    AssertAlmostEqual(&test, rTM, 0.9999914122329656);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848958);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848958);
    AssertAlmostEqual(&test, rTM, 0.05810507545848957);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545848906);
    AssertAlmostEqual(&test, rTM, 0.05810507545849009);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545843786);
    AssertAlmostEqual(&test, rTM, 0.05810507545854129);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810507545331723);
    AssertAlmostEqual(&test, rTM, 0.05810507546366192);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810502373505676);
    AssertAlmostEqual(&test, rTM, 0.05810512718192207);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076369567072331);
    AssertAlmostEqual(&test, rTM, 0.08535956494759166);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 0.035/CAPS_hbar_eV; /* 0.035eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999766110046);
    AssertAlmostEqual(&test, rTM, 0.9999999883055022);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999834616110208);
    AssertAlmostEqual(&test, rTM, 0.9999999999834615);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9983475153001782);
    AssertAlmostEqual(&test, rTM, 0.9999999999998346);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9835976783616914);
    AssertAlmostEqual(&test, rTM, 0.9999999999999835);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.8477264594605957);
    AssertAlmostEqual(&test, rTM, 0.9999999999999983);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003629514668034419);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.656005530959261e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999994769914499);
    AssertAlmostEqual(&test, rTM, 0.9999994769919727);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999260354665);
    AssertAlmostEqual(&test, rTM, 0.999999630177264);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999476979102809);
    AssertAlmostEqual(&test, rTM, 0.9999999947701772);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994771280641538);
    AssertAlmostEqual(&test, rTM, 0.9999999994769918);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9947835747268249);
    AssertAlmostEqual(&test, rTM, 0.9999999999476989);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5961733581712475);
    AssertAlmostEqual(&test, rTM, 0.9999999999994593);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -3.655774962004652e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998632);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947554987787);
    AssertAlmostEqual(&test, rTM, 0.9999947554987791);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999947552365611);
    AssertAlmostEqual(&test, rTM, 0.9999947557609835);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999925831633012);
    AssertAlmostEqual(&test, rTM, 0.9999962915747743);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999472946658036);
    AssertAlmostEqual(&test, rTM, 0.9999994781513916);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9994756598011288);
    AssertAlmostEqual(&test, rTM, 0.9999999475574718);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.948912068722634);
    AssertAlmostEqual(&test, rTM, 0.9999999994753682);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000363306960812462);
    AssertAlmostEqual(&test, rTM, 0.9999999999862375);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999983006297655);
    AssertAlmostEqual(&test, rTM, 0.9999830062976549);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999830062891583);
    AssertAlmostEqual(&test, rTM, 0.9999830063061517);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999829215412328);
    AssertAlmostEqual(&test, rTM, 0.9999830906334543);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999759673602527);
    AssertAlmostEqual(&test, rTM, 0.9999879836079291);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998292285372542);
    AssertAlmostEqual(&test, rTM, 0.9999983090504725);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9831499268729033);
    AssertAlmostEqual(&test, rTM, 0.9999999830055484);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.003438938691962654);
    AssertAlmostEqual(&test, rTM, 0.999999999854608);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177250139);
    AssertAlmostEqual(&test, rTM, 0.9999347177250137);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347177246874);
    AssertAlmostEqual(&test, rTM, 0.9999347177253401);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999347144610883);
    AssertAlmostEqual(&test, rTM, 0.9999347209887761);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999343921362938);
    AssertAlmostEqual(&test, rTM, 0.9999350416980041);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999076781696093);
    AssertAlmostEqual(&test, rTM, 0.9999538380193158);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9934925106018196);
    AssertAlmostEqual(&test, rTM, 0.9999993471853155);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0224224727567795);
    AssertAlmostEqual(&test, rTM, 0.9999999977712154);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996065453679612);
    AssertAlmostEqual(&test, rTM, 0.9960654536796119);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.99606545367961);
    AssertAlmostEqual(&test, rTM, 0.9960654536796139);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996065453659978);
    AssertAlmostEqual(&test, rTM, 0.9960654536992458);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960654517162171);
    AssertAlmostEqual(&test, rTM, 0.9960654556430057);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960652573450028);
    AssertAlmostEqual(&test, rTM, 0.9960656500044437);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944402524899426);
    AssertAlmostEqual(&test, rTM, 0.9972162462169422);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05719309836716478);
    AssertAlmostEqual(&test, rTM, 0.9999912863635126);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.0581042282981928);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829819281);
    AssertAlmostEqual(&test, rTM, 0.0581042282981928);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581042282981923);
    AssertAlmostEqual(&test, rTM, 0.05810422829819333);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829814109);
    AssertAlmostEqual(&test, rTM, 0.05810422829824453);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810422829302053);
    AssertAlmostEqual(&test, rTM, 0.05810422830336508);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810417657542619);
    AssertAlmostEqual(&test, rTM, 0.05810428002095912);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076322187996065);
    AssertAlmostEqual(&test, rTM, 0.08535834805843227);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 0.05/CAPS_hbar_eV; /* 0.05eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999720448038);
    AssertAlmostEqual(&test, rTM, 0.9999999860224017);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999802328764172);
    AssertAlmostEqual(&test, rTM, 0.9999999999802326);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9980252218597808);
    AssertAlmostEqual(&test, rTM, 0.9999999999998023);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9804270987050643);
    AssertAlmostEqual(&test, rTM, 0.9999999999999801);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.820901080272872);
    AssertAlmostEqual(&test, rTM, 0.999999999999998);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002546188095571644);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559203920142499e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999998);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999993748904837);
    AssertAlmostEqual(&test, rTM, 0.9999993748911087);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999991159622005);
    AssertAlmostEqual(&test, rTM, 0.9999995579810025);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999374878885866);
    AssertAlmostEqual(&test, rTM, 0.9999999937492186);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993750856388055);
    AssertAlmostEqual(&test, rTM, 0.9999999993748908);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9937684135316336);
    AssertAlmostEqual(&test, rTM, 0.9999999999374887);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.5404492432767569);
    AssertAlmostEqual(&test, rTM, 0.999999999999345);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -2.559090939205709e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999998046);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937368469279);
    AssertAlmostEqual(&test, rTM, 0.9999937368469284);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999937365337794);
    AssertAlmostEqual(&test, rTM, 0.9999937371600613);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911425754721);
    AssertAlmostEqual(&test, rTM, 0.9999955712779292);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999370578744666);
    AssertAlmostEqual(&test, rTM, 0.9999993767912188);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9993738475419319);
    AssertAlmostEqual(&test, rTM, 0.9999999373714034);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9392989360371629);
    AssertAlmostEqual(&test, rTM, 0.9999999993733757);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000254794405561247);
    AssertAlmostEqual(&test, rTM, 0.9999999999803763);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503946992);
    AssertAlmostEqual(&test, rTM, 0.9999798503946992);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999798503846246);
    AssertAlmostEqual(&test, rTM, 0.9999798504047738);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999797498983088);
    AssertAlmostEqual(&test, rTM, 0.9999799503923551);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999715042738246);
    AssertAlmostEqual(&test, rTM, 0.9999857520354093);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997975174354314);
    AssertAlmostEqual(&test, rTM, 0.9999979950211357);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.980052166592751);
    AssertAlmostEqual(&test, rTM, 0.9999999798491793);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.002450906360904263);
    AssertAlmostEqual(&test, rTM, 0.999999999795995);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999926285058819);
    AssertAlmostEqual(&test, rTM, 0.9999262850588189);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262850584504);
    AssertAlmostEqual(&test, rTM, 0.9999262850591875);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999262813733);
    AssertAlmostEqual(&test, rTM, 0.9999262887441537);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999259174145902);
    AssertAlmostEqual(&test, rTM, 0.9999266508786334);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999895752922029);
    AssertAlmostEqual(&test, rTM, 0.9999478751024765);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.992654989693261);
    AssertAlmostEqual(&test, rTM, 0.9999992628555382);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0177540497270444);
    AssertAlmostEqual(&test, rTM, 0.9999999971846288);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134292);
    AssertAlmostEqual(&test, rTM, 0.9960506727134291);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506727134273);
    AssertAlmostEqual(&test, rTM, 0.9960506727134311);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506726937216);
    AssertAlmostEqual(&test, rTM, 0.9960506727331366);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960506707426731);
    AssertAlmostEqual(&test, rTM, 0.9960506746841843);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960504756427122);
    AssertAlmostEqual(&test, rTM, 0.9960508697743322);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9944193832584296);
    AssertAlmostEqual(&test, rTM, 0.997205782356699);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05681097285518611);
    AssertAlmostEqual(&test, rTM, 0.9999912273704158);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033611);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120033612);
    AssertAlmostEqual(&test, rTM, 0.05810383120033611);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0581038312003356);
    AssertAlmostEqual(&test, rTM, 0.05810383120033663);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383120028439);
    AssertAlmostEqual(&test, rTM, 0.05810383120038783);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810383119516387);
    AssertAlmostEqual(&test, rTM, 0.05810383120550836);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810377947788176);
    AssertAlmostEqual(&test, rTM, 0.05810388292279016);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076299979556908);
    AssertAlmostEqual(&test, rTM, 0.08535777765360517);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 0.1/CAPS_hbar_eV; /* 0.1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999999604653831);
    AssertAlmostEqual(&test, rTM, 0.9999999802326912);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999972045180459);
    AssertAlmostEqual(&test, rTM, 0.9999999999720448);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083851032575);
    AssertAlmostEqual(&test, rTM, 0.9999999999997204);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9724328194772872);
    AssertAlmostEqual(&test, rTM, 0.999999999999972);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7568050478149457);
    AssertAlmostEqual(&test, rTM, 0.9999999999999971);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001276337667697707);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279601988346011e-09);
    AssertAlmostEqual(&test, rTM, 0.9999999999999996);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999999115970394);
    AssertAlmostEqual(&test, rTM, 0.999999115971278);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999987497941958);
    AssertAlmostEqual(&test, rTM, 0.9999993748969024);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999911596532337);
    AssertAlmostEqual(&test, rTM, 0.9999999911601464);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991163606714283);
    AssertAlmostEqual(&test, rTM, 0.9999999991159707);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911986934625912);
    AssertAlmostEqual(&test, rTM, 0.9999999999115962);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242154357919069);
    AssertAlmostEqual(&test, rTM, 0.9999999999990334);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279573742484986e-06);
    AssertAlmostEqual(&test, rTM, 0.9999999999996092);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911511984719);
    AssertAlmostEqual(&test, rTM, 0.9999911511984727);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999911507560454);
    AssertAlmostEqual(&test, rTM, 0.9999911516408773);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999987485927803);
    AssertAlmostEqual(&test, rTM, 0.999993742944326);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059517);
    AssertAlmostEqual(&test, rTM, 0.9999991195078302);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991154631514828);
    AssertAlmostEqual(&test, rTM, 0.9999999115160125);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153401240024596);
    AssertAlmostEqual(&test, rTM, 0.9999999991142502);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.000127678079513639);
    AssertAlmostEqual(&test, rTM, 0.999999999960839);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734384374);
    AssertAlmostEqual(&test, rTM, 0.9999717734384374);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999717734243243);
    AssertAlmostEqual(&test, rTM, 0.9999717734525504);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999716326587053);
    AssertAlmostEqual(&test, rTM, 0.9999719135195261);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999960081847181);
    AssertAlmostEqual(&test, rTM, 0.9999800407244021);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970266);
    AssertAlmostEqual(&test, rTM, 0.9999971913164258);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721685958454005);
    AssertAlmostEqual(&test, rTM, 0.9999999717702434);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483429324);
    AssertAlmostEqual(&test, rTM, 0.9999999996006206);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999903351900146);
    AssertAlmostEqual(&test, rTM, 0.9999033519001459);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033518996628);
    AssertAlmostEqual(&test, rTM, 0.9999033519006291);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999033470680954);
    AssertAlmostEqual(&test, rTM, 0.999903356731955);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999028698851563);
    AssertAlmostEqual(&test, rTM, 0.9999038315232175);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998633216823869);
    AssertAlmostEqual(&test, rTM, 0.9999316585058337);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9903808402678071);
    AssertAlmostEqual(&test, rTM, 0.999999033509799);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.01048140030870607);
    AssertAlmostEqual(&test, rTM, 0.999999995230169);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894189);
    AssertAlmostEqual(&test, rTM, 0.9960017997894188);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017997894169);
    AssertAlmostEqual(&test, rTM, 0.9960017997894208);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.996001799769468);
    AssertAlmostEqual(&test, rTM, 0.9960017998093699);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960017977943237);
    AssertAlmostEqual(&test, rTM, 0.996001801784513);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9960016002848566);
    AssertAlmostEqual(&test, rTM, 0.9960019992840468);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.994350380540905);
    AssertAlmostEqual(&test, rTM, 0.9971711835179783);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05557340764718826);
    AssertAlmostEqual(&test, rTM, 0.9999910307629954);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014589);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014589);
    AssertAlmostEqual(&test, rTM, 0.05810250758014588);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758014537);
    AssertAlmostEqual(&test, rTM, 0.05810250758014639);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250758009416);
    AssertAlmostEqual(&test, rTM, 0.0581025075801976);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810250757497374);
    AssertAlmostEqual(&test, rTM, 0.05810250758531803);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05810245585873239);
    AssertAlmostEqual(&test, rTM, 0.05810255930155906);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03076225953744344);
    AssertAlmostEqual(&test, rTM, 0.08535587635934319);

    userdata[0] = 1000/CAPS_hbar_eV; /* 1000eV */
    userdata[1] = 1/CAPS_hbar_eV; /* 1eV */
    caps_set_epsilonm1(caps, caps_epsilonm1_drude, userdata);

    caps_fresnel(caps, 1e-06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999998749805704);
    AssertAlmostEqual(&test, rTM, 0.9999999374902832);

    caps_fresnel(caps, 1e-06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999116017711897);
    AssertAlmostEqual(&test, rTM, 0.9999999999115979);

    caps_fresnel(caps, 1e-06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9911987790931187);
    AssertAlmostEqual(&test, rTM, 0.9999999999991159);

    caps_fresnel(caps, 1e-06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9154190580621702);
    AssertAlmostEqual(&test, rTM, 0.9999999999999114);

    caps_fresnel(caps, 1e-06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.4242187861264693);
    AssertAlmostEqual(&test, rTM, 0.9999999999999902);

    caps_fresnel(caps, 1e-06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001279274642580166);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 1e-06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279602013793296e-10);
    AssertAlmostEqual(&test, rTM, 0.999999999999996);

    caps_fresnel(caps, 0.001, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999972044801755);
    AssertAlmostEqual(&test, rTM, 0.9999972044829709);

    caps_fresnel(caps, 0.001, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999996046542216);
    AssertAlmostEqual(&test, rTM, 0.9999980232691541);

    caps_fresnel(caps, 0.001, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997204728652098);
    AssertAlmostEqual(&test, rTM, 0.9999999720461744);

    caps_fresnel(caps, 0.001, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972083810135505);
    AssertAlmostEqual(&test, rTM, 0.9999999972044763);

    caps_fresnel(caps, 0.001, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.97243279305386);
    AssertAlmostEqual(&test, rTM, 0.9999999997204204);

    caps_fresnel(caps, 0.001, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.1029656209568222);
    AssertAlmostEqual(&test, rTM, 0.9999999999951954);

    caps_fresnel(caps, 0.001, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.279599189150777e-07);
    AssertAlmostEqual(&test, rTM, 0.9999999999960925);

    caps_fresnel(caps, 0.1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999720424640689);
    AssertAlmostEqual(&test, rTM, 0.9999720424640716);

    caps_fresnel(caps, 0.1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999972041066248);
    AssertAlmostEqual(&test, rTM, 0.9999720438618226);

    caps_fresnel(caps, 0.1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999604623024525);
    AssertAlmostEqual(&test, rTM, 0.9999802309558167);

    caps_fresnel(caps, 0.1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997190657838734);
    AssertAlmostEqual(&test, rTM, 0.9999972180861548);

    caps_fresnel(caps, 0.1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9972079734259838);
    AssertAlmostEqual(&test, rTM, 0.9999997204344763);

    caps_fresnel(caps, 0.1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.7567845818886872);
    AssertAlmostEqual(&test, rTM, 0.9999999971770229);

    caps_fresnel(caps, 0.1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -1.27931933166733e-05);
    AssertAlmostEqual(&test, rTM, 0.9999999996091671);

    caps_fresnel(caps, 1, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.999911515508227);
    AssertAlmostEqual(&test, rTM, 0.999911515508227);

    caps_fresnel(caps, 1, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999115154639868);
    AssertAlmostEqual(&test, rTM, 0.9999115155524672);

    caps_fresnel(caps, 1, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9999110742059517);
    AssertAlmostEqual(&test, rTM, 0.9999119546205963);

    caps_fresnel(caps, 1, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9998748663249645);
    AssertAlmostEqual(&test, rTM, 0.9999374312049939);

    caps_fresnel(caps, 1, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9991110978549883);
    AssertAlmostEqual(&test, rTM, 0.9999911951123446);

    caps_fresnel(caps, 1, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9153400839481458);
    AssertAlmostEqual(&test, rTM, 0.9999999114250736);

    caps_fresnel(caps, 1, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.0001276780795135127);
    AssertAlmostEqual(&test, rTM, 0.999999996083901);

    caps_fresnel(caps, 10, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702358475);
    AssertAlmostEqual(&test, rTM, 0.9997177702358474);

    caps_fresnel(caps, 10, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177702344366);
    AssertAlmostEqual(&test, rTM, 0.9997177702372584);

    caps_fresnel(caps, 10, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997177561267038);
    AssertAlmostEqual(&test, rTM, 0.999717784344286);

    caps_fresnel(caps, 10, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9997163627970266);
    AssertAlmostEqual(&test, rTM, 0.9997191706917838);

    caps_fresnel(caps, 10, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9996008901724517);
    AssertAlmostEqual(&test, rTM, 0.9998004251691821);

    caps_fresnel(caps, 10, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9721672376683953);
    AssertAlmostEqual(&test, rTM, 0.9999971771680436);

    caps_fresnel(caps, 10, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.001251940483305692);
    AssertAlmostEqual(&test, rTM, 0.9999999600620634);

    caps_fresnel(caps, 1000, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010416);
    AssertAlmostEqual(&test, rTM, 0.9952070286010415);

    caps_fresnel(caps, 1000, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070286010393);
    AssertAlmostEqual(&test, rTM, 0.9952070286010439);

    caps_fresnel(caps, 1000, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070285771344);
    AssertAlmostEqual(&test, rTM, 0.9952070286249488);

    caps_fresnel(caps, 1000, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9952070262103135);
    AssertAlmostEqual(&test, rTM, 0.9952070309917685);

    caps_fresnel(caps, 1000, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.995206789534171);
    AssertAlmostEqual(&test, rTM, 0.9952072676560171);

    caps_fresnel(caps, 1000, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.9932284561547626);
    AssertAlmostEqual(&test, rTM, 0.9966084670935593);

    caps_fresnel(caps, 1000, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03993083299880098);
    AssertAlmostEqual(&test, rTM, 0.9999874984760787);

    caps_fresnel(caps, 1e+06, 1e-06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950604);

    caps_fresnel(caps, 1e+06, 0.001, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950605);
    AssertAlmostEqual(&test, rTM, 0.05807869275950604);

    caps_fresnel(caps, 1e+06, 0.1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275950554);
    AssertAlmostEqual(&test, rTM, 0.05807869275950656);

    caps_fresnel(caps, 1e+06, 1, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275945435);
    AssertAlmostEqual(&test, rTM, 0.05807869275955774);

    caps_fresnel(caps, 1e+06, 10, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807869275433578);
    AssertAlmostEqual(&test, rTM, 0.05807869276467632);

    caps_fresnel(caps, 1e+06, 1000, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.05807864105682106);
    AssertAlmostEqual(&test, rTM, 0.05807874446219072);

    caps_fresnel(caps, 1e+06, 1e+06, &rTE, &rTM);
    AssertAlmostEqual(&test, rTE, -0.03074894098636187);
    AssertAlmostEqual(&test, rTM, 0.08532166756813654);


    caps_free(caps);

    return test_results(&test, stderr);
}
